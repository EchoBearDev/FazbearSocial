<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazbear Social Hub v13.5 (Fix Final y Búsqueda de Usuarios)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ESTILOS DE LA INTERFAZ ORIGINAL */
        body {font-family: 'VT323', monospace;background:#111;color:#d1d5db;height:100vh;display:flex;justify-content:center;align-items:center;overflow:hidden;margin:0;}
        .pirate-cove {
            background-color: #5b21b6; 
            background-image: radial-gradient(circle, #8b5cf6 10%, transparent 10%), radial-gradient(circle, #ffffff 5%, transparent 5%);
            background-size: 20px 20px, 15px 15px;
            background-position: 0 0, 10px 10px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }
        #splash {position:fixed;top:0;left:0;width:100%;height:100%;background:#111;z-index:1000;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#facc15;}
        .chat-message.own {background-color: #374151;margin-left:auto;}
        .chat-message.other {background-color: #1f2937;margin-right:auto;}
        .gear-card.equipped {border: 4px solid #facc15; box-shadow: 0 0 10px #facc15;}
        .tooltip {position: absolute; background: #000; color: #fff; padding: 5px; border-radius: 5px; z-index: 50; pointer-events: none; opacity: 0; transition: opacity 0.3s;}
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div id="splash">
        <div class="text-4xl">F.A.Z.B.E.A.R.</div>
        <div class="text-2xl mt-2">S O C I A L &nbsp; H U B</div>
        <div class="text-lg mt-8">Cargando datos de seguridad...</div>
        <div class="text-sm mt-1">v13.5 (Fix Final y Búsqueda de Usuarios)</div>
    </div>

    <div id="app" class="hidden w-full h-full max-w-7xl max-h-[900px] flex border-4 border-yellow-500 rounded-lg shadow-2xl bg-gray-800 p-2">
        
        <div class="w-1/4 bg-gray-900 p-4 rounded-lg mr-2 flex flex-col items-center">
            <div id="profile-picture-container" class="relative w-32 h-32 bg-gray-700 rounded-full border-4 border-yellow-500 flex items-center justify-center mb-4">
                <div id="gear-slot" class="absolute w-20 h-20 bg-transparent rounded-full z-10"></div>
                <img id="profile-picture" class="w-full h-full rounded-full object-cover z-0" src="https://i.imgur.com/8QZ9d7m.png" alt="Profile Picture">
            </div>
            <div id="profile-name" class="text-2xl text-yellow-500 mb-1">Cargando...</div>
            <div id="user-role" class="text-sm text-red-500 mb-4">Guardia Nocturno</div>
            
            <div class="w-full bg-gray-700 p-2 rounded-lg mb-4 text-center">
                <div class="text-lg text-green-400">Tokens de Pizzería: <span id="user-tokens">0</span></div>
            </div>

            <div class="w-full space-y-2">
                <button onclick="showSection('feed')" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg transition duration-150 ease-in-out text-lg text-black font-bold">Feed (Teorías)</button>
                <button onclick="showSection('profile')" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg transition duration-150 ease-in-out text-lg text-black font-bold">Mi Perfil</button>
                <button onclick="showSection('chat')" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg transition duration-150 ease-in-out text-lg text-black font-bold">Chat Rápido</button>
                <button onclick="showSection('shop')" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg transition duration-150 ease-in-out text-lg text-black font-bold">Tienda</button>
                <button onclick="showSection('cameras')" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg transition duration-150 ease-in-out text-lg text-black font-bold">Cámaras</button>
            </div>

             <div class="mt-auto pt-4 w-full">
                <button onclick="signOutUser()" class="w-full py-2 bg-red-600 hover:bg-red-500 rounded-lg transition duration-150 ease-in-out text-sm text-white font-bold">CERRAR SESIÓN</button>
            </div>
        </div>

        <div class="w-3/4 bg-gray-900 p-4 rounded-lg flex flex-col">

            <div id="auth-section" class="flex flex-col items-center justify-center h-full space-y-4">
                <h1 class="text-4xl text-yellow-500 mb-6">Acceso de Guardia</h1>
                <input id="auth-username" type="text" placeholder="Nombre de Guardia" class="w-full max-w-md p-3 bg-gray-700 rounded text-lg border border-yellow-500 focus:ring-yellow-500 focus:border-yellow-500 placeholder-gray-400">
                <input id="auth-password" type="password" placeholder="Contraseña de Turno" class="w-full max-w-md p-3 bg-gray-700 rounded text-lg border border-yellow-500 focus:ring-yellow-500 focus:border-yellow-500 placeholder-gray-400">
                <button onclick="signInUser()" class="w-full max-w-md p-3 bg-green-600 hover:bg-green-500 rounded text-xl text-black font-bold transition duration-150">INICIAR SESIÓN</button>
                <button onclick="signUpUser()" class="w-full max-w-md p-3 bg-blue-600 hover:bg-blue-500 rounded text-xl text-black font-bold transition duration-150">REGISTRAR NUEVO GUARDIA</button>
            </div>

            <div id="feed-section" class="hidden h-full flex flex-col">
                <div class="flex mb-4 space-x-2">
                    <input id="search-input" type="text" onkeydown="if(event.key==='Enter')handleSearch()" placeholder="Buscar teorías o usuarios..." class="flex-grow p-3 bg-gray-700 rounded text-lg border border-yellow-500 placeholder-gray-400">
                    <button onclick="handleSearch()" class="p-3 bg-yellow-600 hover:bg-yellow-500 rounded text-black font-bold transition duration-150">Buscar</button>
                    <button onclick="showPostModal()" class="p-3 bg-green-600 hover:bg-green-500 rounded text-black font-bold transition duration-150">Publicar</button>
                </div>
                
                <div id="search-results-container" class="mb-4 hidden p-3 bg-gray-700 rounded-lg overflow-y-auto max-h-40">
                    <h3 class="text-xl text-yellow-500 mb-2 border-b border-yellow-500">Resultados de Búsqueda</h3>
                    <div id="user-results" class="mb-3"></div>
                    <div id="post-results"></div>
                </div>

                <div id="feed-container" class="flex-grow space-y-4 overflow-y-auto">
                    </div>
            </div>

            <div id="profile-section" class="hidden h-full flex flex-col">
                 <div id="profile-details" class="bg-gray-700 p-4 rounded-lg mb-4">
                    <h2 class="text-3xl text-yellow-500 mb-2">Detalles del Guardia</h2>
                    <p class="text-lg">Nombre: <span id="p-name" class="font-bold"></span></p>
                    <p class="text-lg">Rol: <span id="p-role" class="text-red-400 font-bold"></span></p>
                    <p class="text-lg">Tokens: <span id="p-tokens" class="text-green-400 font-bold"></span></p>
                    <p class="text-lg">Gear Equipado: <span id="p-gear" class="font-bold text-blue-400">Ninguno</span></p>
                </div>
                <h2 class="2xl text-yellow-500 mb-2 border-b border-yellow-500">Mis Publicaciones</h2>
                <div id="my-posts-container" class="flex-grow space-y-4 overflow-y-auto">
                    </div>
            </div>

            <div id="chat-section" class="hidden h-full flex flex-col">
                <h2 class="text-3xl text-yellow-500 mb-2 border-b border-yellow-500">Chat Rápido (Guardias)</h2>
                <div id="chat-messages" class="flex-grow overflow-y-auto space-y-3 p-2 mb-4 bg-gray-700 rounded-lg">
                    </div>
                <div class="flex">
                    <input id="chat-input" type="text" onkeydown="if(event.key==='Enter')sendMessage()" placeholder="Escribe un mensaje rápido..." class="flex-grow p-3 bg-gray-800 rounded-l-lg text-lg border border-yellow-500 placeholder-gray-400">
                    <button onclick="sendMessage()" class="p-3 bg-yellow-600 hover:bg-yellow-500 rounded-r-lg text-black font-bold transition duration-150">Enviar</button>
                </div>
            </div>

            <div id="shop-section" class="hidden h-full flex flex-col">
                <h2 class="text-3xl text-yellow-500 mb-4 border-b border-yellow-500">Tienda de Gear (Accesorios)</h2>
                <div id="shop-container" class="flex-grow grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto">
                    </div>
            </div>

            <div id="cameras-section" class="hidden h-full flex flex-col">
                <h2 class="text-3xl text-yellow-500 mb-4 border-b border-yellow-500">Monitoreo de Cámaras</h2>
                <div class="flex space-x-4 mb-4">
                    <div id="map-container" class="w-1/2 bg-gray-700 p-2 rounded-lg relative h-64 border-4 border-yellow-500">
                        <img src="https://i.imgur.com/K3pW11O.png" alt="Mapa de Pizzeria" class="w-full h-full object-cover">
                        </div>
                    <div id="camera-view" class="w-1/2 bg-gray-700 p-2 rounded-lg h-64 relative border-4 border-red-500 flex items-center justify-center overflow-hidden">
                         <div id="cam-name" class="absolute top-1 left-1 bg-gray-900 text-red-500 text-lg px-2 rounded z-10">CAM 01</div>
                        <img id="current-camera-image" src="https://i.imgur.com/8QZ9d7m.png" alt="Vista de Cámara" class="w-full h-full object-cover">
                    </div>
                </div>
                <h3 class="text-2xl text-yellow-500 mb-2 border-b border-yellow-500">Alertas de Cámara</h3>
                <div class="flex space-x-2 mb-4">
                     <input id="camera-alert-input" type="text" onkeydown="if(event.key==='Enter')sendCameraAlert()" placeholder="Enviar alerta sobre la cámara actual..." class="flex-grow p-3 bg-gray-700 rounded text-lg border border-yellow-500 placeholder-gray-400">
                    <button onclick="sendCameraAlert()" class="p-3 bg-red-600 hover:bg-red-500 rounded text-black font-bold transition duration-150">ALERTAR</button>
                </div>
                <div id="camera-alerts-container" class="flex-grow space-y-2 overflow-y-auto">
                    </div>
            </div>
            
        </div>
    </div>

    <div id="post-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-lg border-4 border-yellow-500">
            <h2 class="text-3xl text-yellow-500 mb-4">Nueva Teoría (Post)</h2>
            <textarea id="post-content" placeholder="Escribe tu teoría sobre la pizzería..." class="w-full p-3 bg-gray-700 rounded text-lg border border-yellow-500 mb-4 h-32 resize-none placeholder-gray-400"></textarea>
            <input id="post-image" type="text" placeholder="URL de Imagen (Opcional)" class="w-full p-3 bg-gray-700 rounded text-lg border border-yellow-500 mb-4 placeholder-gray-400">
            <div class="flex justify-end space-x-4">
                <button onclick="hidePostModal()" class="py-2 px-4 bg-red-600 hover:bg-red-500 rounded text-white font-bold">Cancelar</button>
                <button onclick="submitPost()" class="py-2 px-4 bg-green-600 hover:bg-green-500 rounded text-black font-bold">Enviar Teoría</button>
            </div>
        </div>
    </div>

    <div id="comments-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-xl h-5/6 flex flex-col border-4 border-yellow-500">
            <h2 class="text-3xl text-yellow-500 mb-4 border-b border-yellow-500">Comentarios</h2>
            <div id="comments-list" class="flex-grow overflow-y-auto space-y-3 p-2 mb-4 bg-gray-700 rounded-lg">
                </div>
            <div class="flex mt-auto">
                <input id="comment-input" type="text" onkeydown="if(event.key==='Enter')addComment(COMMENT_POST_ID)" placeholder="Escribe tu comentario..." class="flex-grow p-3 bg-gray-800 rounded-l-lg text-lg border border-yellow-500 placeholder-gray-400">
                <button onclick="addComment(COMMENT_POST_ID)" class="p-3 bg-yellow-600 hover:bg-yellow-500 rounded-r-lg text-black font-bold transition duration-150">Comentar</button>
            </div>
             <button onclick="hideCommentsModal()" class="mt-4 py-2 px-4 bg-red-600 hover:bg-red-500 rounded text-white font-bold">Cerrar</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN SUPABASE (DEBES REEMPLAZAR CON TUS CLAVES) ---
        const SUPABASE_URL = 'TU_SUPABASE_URL'; // URL del proyecto
        const SUPABASE_ANON_KEY = 'TU_SUPABASE_ANON_KEY'; // Clave pública 'anon'
        
        // Inicializar Supabase
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variables Globales
        let USER_ID = null;
        let USER_NAME = null;
        let USER_AVATAR = 'https://i.imgur.com/8QZ9d7m.png'; // Avatar por defecto
        let USER_GEAR_ID = null;
        let USER_GEAR_URL = null;
        let USER_TOKENS = 0;
        let IS_ADMIN = false; 
        let CURRENT_CAMERA = 'CAM 01';
        let COMMENT_POST_ID = null;

        // --- AUTHENTICATION FUNCTIONS ---

        async function initApp() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                USER_ID = user.id;
                await loadUserProfile(user.id);
                document.getElementById('splash').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('auth-section').classList.add('hidden');
                showSection('feed');
                
                // Cargar datos al iniciar
                loadFeed(true);
                loadChat();
                loadShop();
                loadCameras(true);

                // Configurar auto-refresco para Chat y Feed
                setupRealtime();
                setInterval(() => {
                    loadChat();
                    loadFeed(false);
                }, 10000); // Refrescar cada 10 segundos
            } else {
                document.getElementById('splash').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }
        }

        async function loadUserProfile(userId) {
            const { data, error } = await supabase
                .from('profiles')
                .select(`name, tokens, is_admin, avatar_url, gear_id, gear(id, name, image_url)`)
                .eq('id', userId)
                .single();

            if (data) {
                USER_NAME = data.name;
                USER_TOKENS = data.tokens;
                IS_ADMIN = data.is_admin;
                USER_AVATAR = data.avatar_url || USER_AVATAR;
                USER_GEAR_ID = data.gear_id;
                USER_GEAR_URL = data.gear ? data.gear.image_url : null;
                
                // Actualizar UI del Perfil
                document.getElementById('profile-name').textContent = USER_NAME;
                document.getElementById('user-tokens').textContent = USER_TOKENS;
                document.getElementById('profile-picture').src = USER_AVATAR;
                document.getElementById('user-role').textContent = IS_ADMIN ? 'Gerente General' : 'Guardia Nocturno';

                // Aplicar Gear (Accesorios)
                const gearSlot = document.getElementById('gear-slot');
                gearSlot.innerHTML = '';
                if (USER_GEAR_URL) {
                     gearSlot.style.backgroundImage = `url('${USER_GEAR_URL}')`;
                     gearSlot.style.backgroundSize = 'contain';
                     gearSlot.style.backgroundRepeat = 'no-repeat';
                     gearSlot.style.backgroundPosition = 'center';
                }
            } else {
                console.error("Error cargando perfil:", error);
            }
        }

        async function signInUser() {
            const email = `${document.getElementById('auth-username').value.trim().toLowerCase()}@fazbear.com`;
            const password = document.getElementById('auth-password').value;

            if (!email || !password) return alert('Por favor, ingresa Nombre y Contraseña.');

            const { error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                alert(`Error al iniciar sesión: ${error.message}.`);
            } else {
                window.location.reload(); 
            }
        }

        async function signUpUser() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value;
            const email = `${username.toLowerCase()}@fazbear.com`;

            if (username.length < 3 || password.length < 6) return alert('Nombre debe tener 3+ caracteres, Contraseña 6+.');

            const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });

            if (authError) {
                 alert(`Error al registrar: ${authError.message}.`);
                 return;
            }

            // Crear perfil del usuario
            const { error: profileError } = await supabase
                .from('profiles')
                .insert([{ id: authData.user.id, name: username, email: email }]);
            
            if (profileError) {
                 await supabase.auth.admin.deleteUser(authData.user.id); // Revertir registro
                 alert(`Error al crear perfil. Intenta de nuevo. Detalles: ${profileError.message}`);
                 return;
            }

            alert('Guardia registrado. ¡Inicia sesión!');
            document.getElementById('auth-password').value = '';
            // No recargar, dejar que inicie sesión
        }

        async function signOutUser() {
            const { error } = await supabase.auth.signOut();
            if (error) console.error(error);
            window.location.reload(); 
        }

        // --- NAVIGATION AND UI FUNCTIONS ---

        function showSection(sectionId) {
            const sections = ['feed-section', 'profile-section', 'chat-section', 'shop-section', 'cameras-section', 'auth-section'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
                document.getElementById(id).classList.remove('flex');
            });
            document.getElementById(`${sectionId}-section`).classList.remove('hidden');
            document.getElementById(`${sectionId}-section`).classList.add('flex');
            
            if (sectionId === 'profile') loadMyPosts();
            if (sectionId === 'chat') loadChat();
            if (sectionId === 'shop') loadShop();
            if (sectionId === 'cameras') loadCameras(false);
        }

        function showPostModal() {
            document.getElementById('post-modal').classList.remove('hidden');
            document.getElementById('post-modal').classList.add('flex');
        }

        function hidePostModal() {
            document.getElementById('post-modal').classList.add('hidden');
            document.getElementById('post-modal').classList.remove('flex');
            document.getElementById('post-content').value = '';
            document.getElementById('post-image').value = '';
        }

        function showCommentsModal(postId) {
            COMMENT_POST_ID = postId;
            loadComments(postId);
            document.getElementById('comments-modal').classList.remove('hidden');
            document.getElementById('comments-modal').classList.add('flex');
        }

        function hideCommentsModal() {
            document.getElementById('comments-modal').classList.add('hidden');
            document.getElementById('comments-modal').classList.remove('flex');
            COMMENT_POST_ID = null;
        }


        // --- FEED AND POSTS FUNCTIONS ---

        async function submitPost() {
            const content = document.getElementById('post-content').value.trim();
            const imageUrl = document.getElementById('post-image').value.trim();

            if (!content) return alert('La teoría no puede estar vacía.');
            if (USER_ID === null) return alert('Debes iniciar sesión para publicar.');

            const { error } = await supabase
                .from('posts')
                .insert([{ 
                    user_id: USER_ID, 
                    content: content, 
                    image_url: imageUrl || null,
                    user_name: USER_NAME,
                    user_avatar: USER_AVATAR
                }]);

            if (error) {
                console.error(error);
                alert('Error al publicar la teoría.');
            } else {
                hidePostModal();
                loadFeed(true);
            }
        }

        async function loadFeed(refresh = false) {
            if (!document.getElementById('feed-section').classList.contains('flex') && !refresh) return;

            const { data: posts, error } = await supabase
                .from('posts')
                .select(`
                    id, content, created_at, user_name, user_avatar, image_url, likes, 
                    comments_count, user_id, 
                    comments(id)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error cargando feed:', error);
                return;
            }

            const container = document.getElementById('feed-container');
            // Si la búsqueda está activa, no sobreescribir el feed.
            if (!document.getElementById('search-results-container').classList.contains('flex') || refresh) {
                 container.innerHTML = ''; 
            }

            posts.forEach(post => {
                // Actualizar el contador de comentarios con el conteo de la relación
                const commentCount = post.comments ? post.comments.length : 0;
                
                const postElement = document.createElement('div');
                postElement.className = 'bg-gray-700 p-4 rounded-lg border border-yellow-500 hover:border-yellow-300 transition duration-150';
                postElement.innerHTML = `
                    <div class="flex items-center mb-3">
                        <img src="${post.user_avatar}" class="w-10 h-10 rounded-full mr-3 object-cover border border-yellow-500" alt="Avatar">
                        <span class="text-xl text-yellow-400 font-bold">${post.user_name}</span>
                        <span class="ml-auto text-sm text-gray-400">${new Date(post.created_at).toLocaleTimeString()}</span>
                    </div>
                    <p class="text-lg mb-3">${post.content}</p>
                    ${post.image_url ? `<img src="${post.image_url}" class="w-full h-auto max-h-64 object-cover rounded mb-3" alt="Post Image">` : ''}
                    <div class="flex space-x-4 text-sm mt-3 border-t border-gray-600 pt-3">
                        <button onclick="likePost('${post.id}')" class="flex items-center text-red-400 hover:text-red-500 transition duration-150">
                            🍕 ${post.likes || 0} Pizza Slices
                        </button>
                        <button onclick="showCommentsModal('${post.id}')" class="flex items-center text-blue-400 hover:text-blue-500 transition duration-150">
                            🎤 <span id="comments-count-${post.id}">${commentCount}</span> Comentarios
                        </button>
                        ${(post.user_id === USER_ID || IS_ADMIN) ? 
                            `<button onclick="deletePost('${post.id}', 'posts')" class="ml-auto text-red-600 hover:text-red-400 transition duration-150">🗑️ Borrar</button>` : ''}
                    </div>
                `;
                container.prepend(postElement); 
            });
        }

        async function loadMyPosts() {
            if (!USER_ID) return;

             const { data: posts, error } = await supabase
                .from('posts')
                .select(`id, content, created_at, likes, comments_count, user_id, comments(id)`)
                .eq('user_id', USER_ID)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error cargando mis posts:', error);
                return;
            }

            const container = document.getElementById('my-posts-container');
            container.innerHTML = '';
            
            // Actualizar detalles del perfil
            document.getElementById('p-name').textContent = USER_NAME;
            document.getElementById('p-role').textContent = IS_ADMIN ? 'Gerente General' : 'Guardia Nocturno';
            document.getElementById('p-tokens').textContent = USER_TOKENS;

            const { data: profile } = await supabase.from('profiles').select('gear(name)').eq('id', USER_ID).single();
            document.getElementById('p-gear').textContent = profile && profile.gear ? profile.gear.name : 'Ninguno';


            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'bg-gray-700 p-4 rounded-lg border border-yellow-500';
                 postElement.innerHTML = `
                    <p class="text-lg mb-3">${post.content}</p>
                    <div class="flex space-x-4 text-sm mt-3 border-t border-gray-600 pt-3">
                        <span class="flex items-center text-red-400">🍕 ${post.likes || 0} Pizza Slices</span>
                        <span class="flex items-center text-blue-400">🎤 ${post.comments ? post.comments.length : 0} Comentarios</span>
                        <button onclick="deletePost('${post.id}', 'posts')" class="ml-auto text-red-600 hover:text-red-400 transition duration-150">🗑️ Borrar</button>
                    </div>
                `;
                container.appendChild(postElement);
            });
        }

        async function likePost(postId) {
            // Lógica de likes pendiente, por ahora solo simula el conteo en el front-end
            alert('Función de Pizza Slices pendiente de implementar.');
        }

        async function deletePost(postId, table) {
             if (confirm(`¿Estás seguro de que quieres BORRAR este elemento?`)) {
                 const { error } = await supabase.from(table).delete().eq('id', postId).eq('user_id', USER_ID);
                 if (error && error.code === '42501' && !IS_ADMIN) { 
                     alert('No tienes permiso para borrar publicaciones de otros guardias.');
                 } else if (error) {
                     console.error(error);
                     alert('Error al borrar la publicación.');
                 } else {
                     alert('Elemento borrado.');
                     if (table === 'posts') { 
                         loadFeed(true); 
                         if(document.getElementById('profile-section').classList.contains('flex')) loadMyPosts();
                     }
                     if (table === 'cameras') loadCameras(true);
                 }
             }
        }
        
        // --- COMMENTS FUNCTIONS (FIXED v13.5) ---

        async function loadComments(postId) {
            const { data: comments, error } = await supabase
                .from('comments')
                .select(`id, content, created_at, user_name, user_avatar, user_id`)
                .eq('post_id', postId)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error cargando comentarios:', error);
                return;
            }

            const container = document.getElementById('comments-list');
            container.innerHTML = '';

            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'p-3 bg-gray-600 rounded-lg border border-gray-500';
                commentElement.innerHTML = `
                    <div class="flex items-center mb-1">
                        <img src="${comment.user_avatar}" class="w-6 h-6 rounded-full mr-2 object-cover border border-yellow-500" alt="Avatar">
                        <span class="text-md text-yellow-400 font-bold">${comment.user_name}</span>
                        <span class="ml-auto text-xs text-gray-400">${new Date(comment.created_at).toLocaleTimeString()}</span>
                    </div>
                    <p class="text-sm">${comment.content}</p>
                    ${(comment.user_id === USER_ID || IS_ADMIN) ? 
                        `<button onclick="deleteComment('${comment.id}', '${comment.post_id}')" class="mt-1 text-xs text-red-400 hover:text-red-500">🗑️ Borrar</button>` : ''}
                `;
                container.appendChild(commentElement);
            });
            container.scrollTop = container.scrollHeight;
        }

        async function addComment(postId) {
            const input = document.getElementById('comment-input');
            const content = input.value.trim();

            if (!content) return alert('El comentario no puede estar vacío.');

            const { error } = await supabase
                .from('comments')
                .insert([{ 
                    post_id: postId, 
                    user_id: USER_ID, 
                    content: content, 
                    user_name: USER_NAME,
                    user_avatar: USER_AVATAR
                }]);

            if (error) {
                console.error('Error al comentar:', error);
                alert('Error al enviar el comentario.');
            } else {
                input.value = '';
                
                // Actualizar contador en la UI del modal
                await loadComments(postId); 

                // Forzar actualización del contador del post en el Feed
                const countElement = document.getElementById(`comments-count-${postId}`);
                if (countElement) {
                    const newCount = parseInt(countElement.textContent) + 1;
                    countElement.textContent = newCount;
                }
            }
        }
        
        async function deleteComment(commentId, postId) {
            if (!confirm('¿Borrar este comentario?')) return;
            
             const { error } = await supabase.from('comments').delete().eq('id', commentId).eq('user_id', USER_ID);
             if (error && error.code === '42501' && !IS_ADMIN) {
                 alert('No tienes permiso para borrar este comentario.');
             } else if (error) {
                 console.error(error);
                 alert('Error al borrar el comentario.');
             } else {
                 await loadComments(postId); // Recargar comentarios
                 
                 // Actualizar el contador del post en el Feed
                 const countElement = document.getElementById(`comments-count-${postId}`);
                 if (countElement) {
                     const newCount = parseInt(countElement.textContent) - 1;
                     countElement.textContent = newCount;
                 }
             }
        }


        // --- CHAT FUNCTIONS ---

        async function loadChat() {
            if (!document.getElementById('chat-section').classList.contains('flex')) return;

            const { data: messages, error } = await supabase
                .from('chat_messages')
                .select(`id, content, created_at, user_name, user_id, user_avatar`)
                .order('created_at', { ascending: true })
                .limit(50);

            if (error) {
                console.error('Error cargando chat:', error);
                return;
            }

            const chatContainer = document.getElementById('chat-messages');
            const shouldScroll = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 50; 
            
            chatContainer.innerHTML = '';

            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                const isOwn = msg.user_id === USER_ID;
                messageElement.className = `chat-message p-2 rounded-lg max-w-xs ${isOwn ? 'own' : 'other'}`;
                messageElement.innerHTML = `
                    <div class="flex items-center mb-1 ${isOwn ? 'justify-end' : 'justify-start'}">
                        <img src="${msg.user_avatar}" class="w-6 h-6 rounded-full ${isOwn ? 'ml-2' : 'mr-2'} object-cover border border-gray-500" alt="Avatar">
                        <span class="text-xs font-bold ${isOwn ? 'text-yellow-400' : 'text-green-400'}">${msg.user_name}</span>
                        <span class="text-xs text-gray-400 ${isOwn ? 'ml-2' : 'mr-2'}">${new Date(msg.created_at).toLocaleTimeString()}</span>
                    </div>
                    <p class="text-sm">${msg.content}</p>
                    ${(isOwn || IS_ADMIN) ? 
                        `<button onclick="deleteChat('${msg.id}')" class="mt-1 text-xs text-red-400 hover:text-red-500 ${isOwn ? 'block text-right' : 'block text-left'}">🗑️ Borrar</button>` : ''}
                `;
                chatContainer.appendChild(messageElement);
            });

            if (shouldScroll) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();

            if (!content) return;

            const { error } = await supabase
                .from('chat_messages')
                .insert([{ 
                    user_id: USER_ID, 
                    content: content, 
                    user_name: USER_NAME,
                    user_avatar: USER_AVATAR
                }]);

            if (error) {
                console.error(error);
                alert('Error al enviar mensaje.');
            } else {
                input.value = '';
                loadChat(); 
            }
        }
        
        async function deleteChat(chatId) {
             if (confirm('¿Borrar este mensaje?')) {
                 const { error } = await supabase.from('chat_messages').delete().eq('id', chatId).eq('user_id', USER_ID);
                 if (error && error.code === '42501' && !IS_ADMIN) {
                      alert('No tienes permiso para borrar mensajes de otros.');
                 } else if (error) {
                      console.error(error);
                      alert('Error al borrar el mensaje.');
                 } else {
                      loadChat();
                 }
             }
        }

        // --- SHOP FUNCTIONS (FIXED v13.5) ---

        async function loadShop() {
            if (!document.getElementById('shop-section').classList.contains('flex')) return;

            const { data: gears, error: gearError } = await supabase
                .from('gear')
                .select('*');

            const { data: ownedGears, error: ownedError } = await supabase
                .from('owned_gear')
                .select('gear_id')
                .eq('user_id', USER_ID);

            if (gearError || ownedError) {
                console.error('Error cargando tienda/inventario:', gearError || ownedError);
                return;
            }

            const ownedIds = new Set(ownedGears.map(og => og.gear_id));
            const shopContainer = document.getElementById('shop-container');
            shopContainer.innerHTML = '';

            gears.forEach(gear => {
                const isOwned = ownedIds.has(gear.id);
                const isEquipped = gear.id === USER_GEAR_ID;
                
                let buttonText;
                let buttonClass;
                let action;

                if (isEquipped) {
                    buttonText = 'EQUIPADO';
                    buttonClass = 'bg-green-500 hover:bg-green-400';
                    action = `buyGear('${gear.id}', true, true)`; // true para isEquipped
                } else if (isOwned) {
                    buttonText = 'Equipar';
                    buttonClass = 'bg-blue-600 hover:bg-blue-500';
                    action = `buyGear('${gear.id}', true, false)`; // true para isOwned, false para isEquipped
                } else {
                    buttonText = `Comprar (${gear.price} $)`; // Usamos $ como símbolo de Token
                    buttonClass = 'bg-yellow-600 hover:bg-yellow-500';
                    action = `buyGear('${gear.id}', false, false, ${gear.price})`; // false para isOwned/isEquipped
                }
                
                const gearElement = document.createElement('div');
                gearElement.className = `gear-card p-3 bg-gray-700 rounded-lg text-center ${isEquipped ? 'equipped' : 'border border-gray-600'}`;
                gearElement.innerHTML = `
                    <img src="${gear.image_url}" class="w-full h-24 object-contain mx-auto mb-2" alt="${gear.name}">
                    <div class="text-xl text-yellow-400 font-bold mb-1">${gear.name}</div>
                    <p class="text-sm mb-3">${gear.description}</p>
                    <button onclick="${action}" class="w-full py-2 ${buttonClass} rounded text-black font-bold transition duration-150 text-sm">
                        ${buttonText}
                    </button>
                `;
                shopContainer.appendChild(gearElement);
            });
            
            // Si el usuario tiene gear equipado, agregar un botón para "Desequipar"
            if(USER_GEAR_ID) {
                 const desequipElement = document.createElement('div');
                 desequipElement.className = `p-3 bg-gray-700 rounded-lg text-center border border-red-500`;
                 desequipElement.innerHTML = `
                    <div class="text-xl text-red-400 font-bold mb-1">Slot de Gear</div>
                    <p class="text-sm mb-3">Quitar accesorio de tu avatar.</p>
                    <button onclick="unequipGear()" class="w-full py-2 bg-red-600 hover:bg-red-500 rounded text-black font-bold transition duration-150 text-sm">
                        Desequipar Todo
                    </button>
                 `;
                 shopContainer.prepend(desequipElement);
            }
        }

        async function buyGear(gearId, isOwned, isEquipped, price = 0) {
            
            // 1. Desequipar
            if (isEquipped) {
                await unequipGear();
                return;
            }

            // 2. Equipar (Ya es dueño, pero no equipado)
            if (isOwned && !isEquipped) {
                await equipGear(gearId);
                return;
            }

            // 3. Comprar (No es dueño)
            if (!isOwned) {
                 if (USER_TOKENS < price) return alert(`Necesitas ${price} Tokens. Solo tienes ${USER_TOKENS}.`);

                if (!confirm(`¿Confirmar compra de este ítem por ${price} Tokens?`)) return;

                // Transacción: Insertar owned_gear y actualizar tokens
                const { error: insertError } = await supabase
                    .from('owned_gear')
                    .insert([{ user_id: USER_ID, gear_id: gearId }]);
                
                if (insertError) {
                    if (insertError.code === '23505') { // Ya tiene el item
                        alert('Ya tienes este ítem. Solo necesitas equiparlo.');
                        await equipGear(gearId); // Equipar si ya lo tiene
                    } else {
                        console.error('Error comprando:', insertError);
                        alert('Error al completar la compra.');
                    }
                    return;
                }

                const newTokens = USER_TOKENS - price;
                const { error: tokenError } = await supabase
                    .from('profiles')
                    .update({ tokens: newTokens, gear_id: gearId }) // Equipar automáticamente
                    .eq('id', USER_ID);

                if (tokenError) {
                    console.error('Error actualizando tokens:', tokenError);
                    alert('Compra exitosa, pero error al actualizar tokens/equipo. Recarga la página.');
                    return;
                }
                
                USER_TOKENS = newTokens;
                document.getElementById('user-tokens').textContent = USER_TOKENS;
                alert('¡Compra exitosa! Ítem equipado automáticamente.');
                await loadUserProfile(USER_ID); // Forzar recarga del avatar
                loadShop(); // Recargar la tienda para ver el estado
            }
        }
        
        async function equipGear(gearId) {
            const { error } = await supabase
                 .from('profiles')
                 .update({ gear_id: gearId })
                 .eq('id', USER_ID);

            if (error) {
                console.error('Error equipando:', error);
                alert('Error al equipar el ítem.');
                return;
            }
            alert('¡Ítem equipado!');
            await loadUserProfile(USER_ID);
            loadShop();
        }
        
        async function unequipGear() {
             const { error } = await supabase
                 .from('profiles')
                 .update({ gear_id: null })
                 .eq('id', USER_ID);

            if (error) {
                console.error('Error desequipando:', error);
                alert('Error al desequipar el ítem.');
                return;
            }
            alert('Ítem desequipado.');
            await loadUserProfile(USER_ID);
            loadShop();
        }

        // --- SEARCH FUNCTIONS (NEW v13.5) ---
        
        async function handleSearch() {
            const query = document.getElementById('search-input').value.trim();
            const resultsContainer = document.getElementById('search-results-container');
            const userResultsDiv = document.getElementById('user-results');
            const postResultsDiv = document.getElementById('post-results');

            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                loadFeed(true); // Recargar feed completo si se borra la búsqueda
                return;
            }

            userResultsDiv.innerHTML = '<h4 class="text-lg text-blue-400 mb-1">Usuarios Encontrados:</h4>';
            postResultsDiv.innerHTML = '<h4 class="text-lg text-blue-400 mb-1">Teorías Encontradas:</h4>';
            resultsContainer.classList.remove('hidden');

            // 1. Buscar Usuarios (profiles)
            const { data: users, error: userError } = await supabase
                .from('profiles')
                .select(`id, name, avatar_url`)
                .ilike('name', `%${query}%`);

            if (userError) console.error('Error buscando usuarios:', userError);

            if (users && users.length > 0) {
                users.forEach(user => {
                    const userLink = document.createElement('div');
                    userLink.className = 'flex items-center p-1 bg-gray-600 rounded mb-1 hover:bg-gray-500 cursor-pointer';
                    userLink.innerHTML = `
                        <img src="${user.avatar_url}" class="w-6 h-6 rounded-full mr-2 object-cover" alt="Avatar">
                        <span class="text-md text-yellow-300">${user.name}</span>
                    `;
                    // NOTA: Por ahora, solo muestra el resultado.
                    userResultsDiv.appendChild(userLink);
                });
            } else {
                 userResultsDiv.innerHTML += '<p class="text-sm text-gray-400">Ningún usuario encontrado.</p>';
            }

            // 2. Buscar Publicaciones (posts)
            const { data: posts, error: postError } = await supabase
                .from('posts')
                .select(`id, content, user_name, created_at, likes, comments_count`)
                .ilike('content', `%${query}%`)
                .order('created_at', { ascending: false });

            if (postError) console.error('Error buscando publicaciones:', postError);

            if (posts && posts.length > 0) {
                 posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'bg-gray-700 p-2 rounded-lg border border-gray-600 mb-2';
                    postElement.innerHTML = `
                        <div class="text-yellow-400 font-bold">${post.user_name}</div>
                        <p class="text-sm line-clamp-2">${post.content}</p>
                        <div class="flex text-xs text-gray-400 space-x-2">
                             <span>🍕 ${post.likes || 0}</span>
                             <span>🎤 ${post.comments_count || 0}</span>
                             <button onclick="showCommentsModal('${post.id}')" class="ml-auto text-blue-400 hover:text-blue-300">Ver</button>
                        </div>
                    `;
                    postResultsDiv.appendChild(postElement);
                 });
            } else {
                 postResultsDiv.innerHTML += '<p class="text-sm text-gray-400">Ninguna teoría encontrada.</p>';
            }
            
            // Ocultar el feed principal para mostrar solo los resultados
            document.getElementById('feed-container').innerHTML = '';
        }


        // --- CAMERAS AND ALERTS FUNCTIONS ---

        async function loadCameras(initial = false) {
             
             if (!document.getElementById('cameras-section').classList.contains('flex') && !initial) return;
             
             const { data: alerts, error } = await supabase
                .from('cameras')
                .select(`id, camera_name, alert_content, created_at, user_name`)
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) {
                console.error('Error cargando alertas:', error);
                return;
            }

            const alertsContainer = document.getElementById('camera-alerts-container');
            alertsContainer.innerHTML = '';
            
            alerts.forEach(alert => {
                const alertElement = document.createElement('div');
                alertElement.className = `p-2 rounded-lg ${alert.camera_name === CURRENT_CAMERA ? 'bg-red-900 border border-red-500' : 'bg-gray-700 border border-gray-600'}`;
                 alertElement.innerHTML = `
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-bold text-red-400">${alert.camera_name}</span>
                        <span class="text-xs text-gray-400">${new Date(alert.created_at).toLocaleTimeString()} - ${alert.user_name}</span>
                        ${(alert.user_name === USER_NAME || IS_ADMIN) ? 
                            `<button onclick="deletePost('${alert.id}', 'cameras')" class="text-red-600 hover:text-red-400 transition duration-150">🗑️</button>` : ''}
                    </div>
                    <p class="text-sm mt-1">${alert.alert_content}</p>
                `;
                alertsContainer.appendChild(alertElement);
            });
            
            // Inicialización de mapa/cámaras
            if(initial) {
                const mapContainer = document.getElementById('map-container');
                mapContainer.innerHTML = `<img src="https://i.imgur.com/K3pW11O.png" alt="Mapa de Pizzería" class="w-full h-full object-cover">`;
                
                // Definiciones de cámaras (posición en el mapa)
                const cameras = [
                    { id: 'CAM 01', left: '10%', top: '20%', img: 'https://i.imgur.com/k2j4M3V.png' }, // Sala principal
                    { id: 'CAM 02', left: '40%', top: '10%', img: 'https://i.imgur.com/z4X6H2x.png' }, // Escenario
                    { id: 'CAM 03', left: '80%', top: '30%', img: 'https://i.imgur.com/7b0tD7J.png' }, // Cocina
                    { id: 'CAM 04', left: '20%', top: '70%', img: 'https://i.imgur.com/mC2W0qL.png' }, // Backstage
                    { id: 'CAM 05', left: '70%', top: '80%', img: 'https://i.imgur.com/vH4v9Z0.png' }  // Pirate Cove
                ];

                cameras.forEach(cam => {
                    const dot = document.createElement('div');
                    dot.className = `absolute w-4 h-4 rounded-full bg-yellow-500 border-2 border-black cursor-pointer hover:bg-red-500 transition duration-150`;
                    dot.style.left = cam.left;
                    dot.style.top = cam.top;
                    dot.setAttribute('title', cam.id);
                    dot.onclick = () => viewCamera(cam.id, cam.img);
                    mapContainer.appendChild(dot);
                });
                
                viewCamera('CAM 01', 'https://i.imgur.com/k2j4M3V.png'); // Carga la primera cámara
            }
        }

        function viewCamera(cameraId, imageUrl) {
            CURRENT_CAMERA = cameraId;
            document.getElementById('cam-name').textContent = cameraId;
            document.getElementById('current-camera-image').src = imageUrl;
            
            // Resaltar el nombre de la cámara en el panel de alertas
            loadCameras(false); 
        }
        
        async function sendCameraAlert() {
            const input = document.getElementById('camera-alert-input');
            const content = input.value.trim();

            if (!content) return;

            const { error } = await supabase
                .from('cameras')
                .insert([{ 
                    user_id: USER_ID, 
                    camera_name: CURRENT_CAMERA,
                    alert_content: content,
                    user_name: USER_NAME
                }]);

            if (error) {
                console.error(error);
                alert('Error al enviar la alerta.');
            } else {
                input.value = '';
                loadCameras(false); 
            }
        }


        // --- REALTIME SUBSCRIPTION (CHAT) ---
        function setupRealtime() {
            supabase.channel('public:chat_messages')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, () => {
                    if (document.getElementById('chat-section').classList.contains('flex')) {
                       loadChat();
                    }
                })
                .subscribe();

            // Realtime para posts
             supabase.channel('public:posts')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, () => {
                    if (document.getElementById('feed-section').classList.contains('flex')) {
                       loadFeed(true);
                    }
                })
                .subscribe();
        }

        // Initialize the app when the DOM is ready
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
