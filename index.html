<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazbear Social Hub v13.4 (Fix de Cach√©)</title>
    <script src="https://cdn.tailwindcss.com?v=134"></script> 
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {font-family: 'VT323', monospace;background:#111;color:#d1d5db;height:100vh;display:flex;justify-content:center;align-items:center;overflow:hidden;margin:0;}
        .pirate-cove {
            background-color: #5b21b6; 
            background-image: radial-gradient(circle, #8b5cf6 10%, transparent 10%), radial-gradient(circle, #ffffff 5%, transparent 5%);
            background-size: 20px 20px, 15px 15px;
            background-position: 0 0, 10px 10px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }
        #splash {position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:999;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#9333ea;transition:opacity 1s;opacity:1;}
        .splash-title {font-size:3rem;color:#fff;text-shadow:0 0 15px #9333ea;animation:pulse 1.5s infinite alternate;}
        @keyframes pulse {from{transform:scale(1)}to{transform:scale(1.05)}}
        .loading-bar {width:80%;max-width:400px;height:10px;background:#333;border:1px solid #9333ea;overflow:hidden;}
        .progress {height:100%;width:0%;background:#fff;transition:width 0.8s;}
        .monitor {background:#1a1a1a;border:5px solid #5a5a5a;box-shadow:0 0 30px rgba(147, 51, 234, 0.4);width:100%;max-width:800px;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
        .tab-btn {background:#2a2a2a;color:#d1d5db;padding:1rem;text-align:left;}
        .tab-btn.active {background:#111;color:#fff;border-left:5px solid #9333ea;}
        .content {flex-grow:1;overflow-y:auto;padding:1rem;padding-bottom:5rem;}
        .post {background:#222;padding:1rem;margin-bottom:1rem;border-left:5px solid #9333ea;border-radius:0 8px 8px 0;}
        .pizza-btn {background:#9333ea;color:white;padding:0.5rem 1rem;border-radius:50px;font-size:0.8rem;transition:background 0.1s;}
        .pizza-btn.active-like {background:white;color:#9333ea;font-weight:bold;}
        .pizza-btn:disabled {opacity:0.5;cursor:not-allowed;}
        .comment-input {width:100%;padding:0.5rem;background:#333;color:#fff;border:1px solid #555;margin-top:0.5rem;}
        .fab {position:fixed;bottom:1rem;right:1rem;width:3.5rem;height:3.5rem;background:#9333ea;color:white;border-radius:50%;font-size:2rem;display:flex;align-items:center;justify-content:center;box-shadow:0 0 15px #9333ea;z-index:10;padding:0;overflow:hidden;}
        .fab img {width:100%;height:100%;object-fit:cover;}
        .hidden {display:none !important;}
        .send-btn {background:#9333ea;color:white;padding:0.5rem 1rem;border-radius:50px;margin-left:0.5rem;}
        .chat-input-area {position:fixed;bottom:0;left:0;right:0;background:#1a1a1a;border-top:3px solid #9333ea;padding:0.75rem;display:flex;align-items:center;z-index:20;}
        .delete-btn {color:red;font-size:0.7rem;margin-left:1rem;cursor:pointer;}
        
        .notification-icon {position:relative;}
        .notification-dot {position:absolute;top:-5px;right:-5px;width:10px;height:10px;background:red;border-radius:50%;display:none;}
        .username-link {cursor:pointer;text-decoration:underline;text-decoration-color: #5b21b6;}
        .camera-video {width: 100%;max-height: 400px;object-fit: contain;background-color: black;}
        #auth-screen {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.95);z-index: 1000;display: flex;flex-direction: column;justify-content: center;align-items: center;color: #d1d5db;}
        .auth-container {background: #222;padding: 2rem;border: 5px solid #9333ea;box-shadow: 0 0 20px #9333ea;max-width: 400px;width: 90%;text-align: center;}
        .pin-input {text-align: center;font-size: 2rem;letter-spacing: 1rem;}

        /* === ESTILOS PARA AVATAR/GEAR === */
        .avatar-container {
            position: relative;
        }
        .avatar-base {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #9333ea;
        }
        .avatar-gear {
            position: absolute;
            top: 0; 
            left: 0; 
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none; 
        }
        
        /* === ESTILOS PARA MAPA V13.1 === */
        .map-container {
            position: relative;
            width: 100%;
            padding-bottom: 75%; /* Aspect ratio 4:3 */
            background: #000;
        }
        .map-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: 3px solid #22c55e; /* Green monitor border */
        }
        .map-report {
            background: #1e293b;
            padding: 1rem;
            border-left: 5px solid #22c55e;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="splash">
        <h1 class="splash-title">Fazbear Social Hub</h1>
        <p>CONECTANDO A LA RED...</p>
        <div class="loading-bar"><div id="progress" class="progress"></div></div>
    </div>

    <div id="auth-screen" class="hidden">
        <div class="auth-container">
            <h2 id="auth-title" class="text-3xl text-purple-400 mb-4">INICIAR TURNO DE NOCHE</h2>
            <div id="login-section">
                <p class="text-white mb-2">Ingresa tu N√∫mero de Guardia (PIN de 4 d√≠gitos)</p>
                <input type="number" id="login-pin" placeholder="####" class="comment-input pin-input mb-4" maxlength="4" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
                <button onclick="loginWithPin()" class="pizza-btn w-full">ACCEDER AL MONITOR</button>
                <p class="mt-4 text-sm text-gray-400">¬øEres nuevo? <span onclick="showCreateProfile()" class="text-purple-300 cursor-pointer">Crea un N√∫mero de Guardia</span></p>
            </div>

            <div id="create-section" class="hidden">
                 <p id="maintenance-warning" class="text-red-500 mb-2 hidden font-bold">‚ö†Ô∏è EL INGRESO DE NUEVOS GUARDias EST√Å CERRADO</p>
                 <p class="text-white mb-2">1. Elige tu Nombre √önico</p>
                 <input type="text" id="new-name" placeholder="Nombre √önico (@Usuario)" class="comment-input mb-2" maxlength="20">
                 <p class="text-white mb-2">2. Crea tu N√∫mero de Guardia (PIN de 4 d√≠gitos)</p>
                 <input type="number" id="new-pin" placeholder="####" class="comment-input pin-input mb-4" maxlength="4" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
                 <button onclick="createNewProfile()" class="pizza-btn w-full">CREAR PERFIL</button>
                 <p class="mt-4 text-sm text-gray-400">¬øYa tienes uno? <span onclick="showLogin()" class="text-purple-300 cursor-pointer">Volver a Acceder</span></p>
            </div>
        </div>
    </div>

    <div id="app-monitor" class="monitor hidden">
        <header class="p-3 border-b border-gray-600">
            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center">
                    <button onclick="toggleSidebar()" class="text-2xl mr-3">Men√∫</button>
                    <span id="header-title" class="text-xl text-white">Fazbear Social Hub</span>
                </div>
                <span class="text-yellow-400">üí∞ <span id="faz-tokens-display">0</span> Tokens</span>
            </div>
            <div class="flex justify-between items-center">
                <p class="text-xs text-yellow-400">Turno de Noche: <span id="session-time">00:00:00</span></p>
                <span class="text-green-400">V13.4 | <span id="clock"></span></span>
            </div>
        </header>

        <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-black border-r-4 border-purple-500 transform -translate-x-full transition-transform z-50">
            <div class="p-4">
                <h3 class="text-xl text-purple-500 mb-4">MEN√ö</h3>
                <button id="tab-feed" class="tab-btn active w-full notification-icon" onclick="switchTab('feed')">
                    FEED TEOR√çAS <span id="feed-notification-dot" class="notification-dot"></span>
                </button>
                <button id="tab-map" class="tab-btn w-full" onclick="switchTab('map')">MAPA DE LA PIZZER√çA</button>
                <button id="tab-cameras" class="tab-btn w-full" onclick="switchTab('cameras')">C√ÅMARAS DE SEGURIDAD</button>
                <button id="tab-chat" class="tab-btn w-full" onclick="switchTab('chat')">CHAT R√ÅPIDO</button>
                <button id="tab-private-chat" class="tab-btn w-full" onclick="switchTab('private-chat')">CHAT PRIVADO</button>
                <button id="tab-shop" class="tab-btn w-full" onclick="switchTab('shop')">TIENDA DE TOKENS</button>
                <button id="tab-profile" class="tab-btn w-full" onclick="switchTab('profile')">MI PERFIL</button>
                <button id="tab-info" class="tab-btn w-full" onclick="switchTab('info')">INFO SCOTT</button>
                <button onclick="logout()" class="tab-btn w-full mt-4 text-red-400">CERRAR TURNO</button>
            </div>
        </div>

        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden z-40" onclick="toggleSidebar()"></div>


        <div id="feed" class="content">
            <div class="mb-4">
                 <input type="text" id="search-input" placeholder="Buscar teor√≠as, usuarios o temas..." class="comment-input" onkeyup="handleSearch()">
            </div>
            <div class="flex justify-center mb-4">
                 <button onclick="loadFeed(true)" class="pizza-btn">üîÑ ACTUALIZAR FEED</button>
            </div>
            <p class="text-center text-purple-500">¬°S√© el primero!</p>
        </div>
        
        <div id="cameras" class="content hidden">
            <h2 class="text-xl text-purple-500 mb-4">C√ÅMARAS DE SEGURIDAD (V√≠deos)</h2>
            <div class="flex justify-center mb-4">
                 <button onclick="loadCameras(true)" class="pizza-btn">üîÑ ACTUALIZAR C√ÅMARAS</button>
            </div>
            <div id="cameras-list">
                 <p class="text-center text-gray-500">No hay grabaciones activas.</p>
            </div>
        </div>
        
        <div id="map" class="content hidden">
             <h2 class="text-xl text-green-400 mb-4 border-b border-green-500 pb-2">MAPA T√ÅCTICO DE SEGURIDAD</h2>
             <div class="map-container">
                 <img src="https://placehold.co/800x600/000/22c55e?text=FAZBEAR+MAPA+SALA+DE+SEGURIDAD" class="map-image" alt="Mapa de la Pizzer√≠a">
             </div>
             <div class="map-report">
                 <h3 class="text-lg text-green-400 font-bold mb-2">REPORTE DE POSICI√ìN</h3>
                 <div id="animatronic-status">
                     </div>
             </div>
             <div class="mt-4 flex justify-center">
                <button onclick="loadMap()" class="pizza-btn bg-green-600 hover:bg-green-700">ACTUALIZAR REPORTE</button>
             </div>
        </div>

        <div id="chat" class="content hidden flex flex-col h-full relative">
            <div id="chat-messages" class="flex-grow overflow-y-auto p-2 pb-20"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Escribe un mensaje..." class="comment-input" maxlength="100">
                <button onclick="sendChat()" class="send-btn">ENVIAR</button>
            </div>
        </div>

        <div id="private-chat" class="content hidden flex flex-col items-center justify-center h-full pirate-cove">
            <h2 class="text-3xl text-white mb-4">ERROR 404: C√ìDIGO NO ENCONTRADO</h2>
            <p class="text-xl text-yellow-300 mb-2">CHAT PRIVADO: FUERA DE SERVICIO</p>
            <p class="text-lg text-white text-center">Parece que Foxy est√° reparando el c√≥digo. Vuelve m√°s tarde.</p>
        </div>
        
        <div id="shop" class="content hidden">
            <h2 class="text-xl text-yellow-300 mb-4">TIENDA DE GEAR Y PERSONALIZACI√ìN</h2>
            <p class="text-white mb-4">Tokens Actuales: üí∞ <span id="shop-tokens-display" class="font-bold text-lg">0</span></p>
            <div id="shop-items" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                </div>
            <p class="text-xs text-gray-500 mt-4">Los √≠tems comprados se sobreponen a tu foto de perfil.</p>
        </div>

        <div id="user-profile-view" class="content hidden p-4">
            <button onclick="switchTab('feed')" class="pizza-btn mb-4">‚Üê VOLVER AL FEED</button>
            <div class="bg-gray-800 p-4 rounded mb-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div id="view-avatar-container" class="w-16 h-16 mr-4">
                            </div>
                        <div>
                            <h2 id="view-name" class="text-3xl text-purple-400 font-bold">@Usuario</h2>
                            <p id="view-id" class="text-xs text-gray-400"></p>
                        </div>
                    </div>
                     <div class="flex flex-col space-y-2">
                        <button id="follow-btn" class="pizza-btn" onclick="toggleFollow()">SEGUIR</button>
                        <button id="block-btn" class="pizza-btn bg-red-600 hover:bg-red-700" onclick="toggleBlock()">BLOQUEAR</button>
                     </div>
                </div>
                <p class="text-yellow-400 mb-2">ü§ñ Animatr√≥nicos: <span id="view-followers">0</span></p>
                <p id="view-bio" class="text-gray-300 italic">Cargando biograf√≠a...</p>
            </div>
            <h3 class="text-xl text-white mb-2 border-b border-gray-700 pb-1">PUBLICACIONES DE <span id="view-name-posts"></span>:</h3>
            <div id="user-posts-list">
                <p class="text-center text-gray-500">Cargando publicaciones...</p>
            </div>
        </div>
        
        <div id="profile" class="content hidden p-4">
            <h2 class="text-xl text-purple-500 mb-4">MI PERFIL</h2>
            <p class="text-sm text-gray-400 mb-2">Tu ID √∫nico de Dispositivo: <span id="display-user-id" class="text-white font-bold"></span></p>
            <p class="text-sm text-gray-400 mb-4">Tu PIN de Guardia: <span id="display-user-pin" class="text-white font-bold">####</span></p>

            <div class="bg-gray-700 p-4 rounded mb-4">
                <h3 class="text-yellow-300 text-lg mb-2">ESTAD√çSTICAS DEL GUARDIA</h3>
                <p>üí∞ Faz-Tokens Acumulados: <span id="profile-tokens" class="font-bold text-green-400">0</span></p>
                <p>üçï Pizza Slices Recibidos: <span id="profile-total-likes" class="font-bold">0</span></p>
                <p>üìù Total de Teor√≠as: <span id="profile-total-posts" class="font-bold">0</span></p>
            </div>
            
            <div class="flex items-center mb-2">
                <div id="profile-avatar-display" class="w-10 h-10 mr-4">
                    </div>
                <div>
                     <input type="text" id="profile-name" placeholder="Nombre √önico (ej: @FreddyFazbear)" class="comment-input mb-2">
                     <textarea id="profile-bio" placeholder="Descripci√≥n personal (m√°x 100 caracteres)" class="comment-input h-20 resize-none mb-2" maxlength="100"></textarea>
                     <label class="block text-sm mb-1 text-purple-400">Foto de Perfil (Galer√≠a)</label>
                     <input type="file" id="profile-avatar-file" accept="image/*" class="comment-input mb-2" data-max-size="5242880">
                </div>
            </div>
            <p class="text-xs text-gray-500 mb-2">Si deseas cambiar tu GEAR, visita la TIENDA.</p>
            
            <button id="save-profile-btn" onclick="saveProfile()" class="pizza-btn w-full mb-4">GUARDAR PERFIL</button>
             
            <div id="admin-options" class="hidden bg-gray-700 p-4 rounded mt-4">
                 <h3 class="text-yellow-300 text-lg mb-2">OPCIONES DE ADMIN</h3>
                 <div class="flex items-center">
                     <label for="maintenance-mode" class="mr-3">CERRAR NUEVO INGRESO (MANTENIMIENTO)</label>
                     <input type="checkbox" id="maintenance-mode" onclick="toggleMaintenanceMode()">
                 </div>
                 <p class="text-xs text-gray-300 mt-2">Activar esto impide que usuarios sin perfil creado se registren.</p>
            </div>

        </div>

        <div id="info" class="content hidden p-4">
            <h2 class="text-xl text-purple-500 mb-4 border-b border-purple-500 pb-2">INFORMACI√ìN DEL CREADOR</h2>
            <div class="bg-gray-900 p-4 rounded">
                <h3 class="text-lg font-bold text-white mb-2">Scott Cawthon: El Cerebro de la Noche</h3>
                <p class="text-gray-300 mb-4">Scott Cawthon es el desarrollador de videojuegos estadounidense, escritor y productor detr√°s de la aclamada y aterradora franquicia Five Nights at Freddy's (FNaF). Su carrera comenz√≥ con juegos cristianos antes de pivotar hacia el terror. Despu√©s de recibir cr√≠ticas sobre sus modelos de personajes (que parec√≠an "animatr√≥nicos aterradores"), tom√≥ la retroalimentaci√≥n y la transform√≥ en un fen√≥meno mundial del terror. Es conocido por su discreci√≥n y por crear una de las narrativas m√°s profundas y complejas del mundo de los videojuegos.</p>
                
                <p class="text-sm text-yellow-400 mt-4 border-t border-yellow-700 pt-2">
                    ‚ö†Ô∏è **Aclaraci√≥n de Derechos de Autor:** Todos los derechos de autor, personajes, historia, arte y concepto de Five Nights at Freddy's y sus elementos relacionados (incluyendo la marca Fazbear) son propiedad total de Scott Cawthon. Esta plataforma es un tributo y una comunidad de fans sin fines de lucro.
                </p>
            </div>
        </div>

        <button id="fab" class="fab" onclick="openPostModal(currentTab)">
             <img id="fab-avatar" src="https://placehold.co/56x56/1a1a1a/9333ea?text=+" class="w-full h-full rounded-full border-2 border-white">
        </button>
    </div>

    <div id="post-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 p-4 rounded border border-purple-500 w-full max-w-md">
            <h3 id="modal-title" class="text-purple-300 mb-2">NUEVA TEOR√çA</h3>
            <textarea id="post-content" placeholder="Tu teor√≠a..." class="comment-input h-32 resize-none mb-2"></textarea>
            <label id="file-label" class="block text-sm mb-1 text-purple-400">Imagen (M√°x 5MB)</label>
            <input type="file" id="post-file" accept="image/*" class="comment-input mb-2" data-max-size="5242880">
            <p id="video-warning" class="text-xs text-red-400 mb-2 hidden">‚ö†Ô∏è Solo videos de hasta 15 segundos (.mp4, .mov).</p>
            <button id="submit-post-btn" onclick="submitPost()" class="pizza-btn w-full">PUBLICAR</button>
            <button onclick="closePostModal()" class="mt-2 text-red-400">CERRAR</button>
        </div>
    </div>

    <script>
        // === TUS LLAVES ===
        const SUPABASE_URL = 'https://fnoowiwoqexnlrmhilau.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZub293aXdvcWV4bmxybWhpbGF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjY2OTYsImV4cCI6MjA3Njc0MjY5Nn0.yrPI1mqQ-xRYmEKEFFUhAoOOHKo4VZsW0m15B5RbXE4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // === VARIABLES GLOBALES Y CONSTANTES V13.3 ===
        let profilesCache = {};
        let currentTab = 'feed';
        let targetUserId = null; 
        let loginTime = null; 
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB en bytes 
        const DEFAULT_AVATAR = 'https://placehold.co/40x40/1a1a1a/9333ea?text=U';
        
        // UX-1: INTERVALO DE AUTOREFRESH (30 segundos)
        const REFRESH_INTERVAL = 30000; 

        // ECON-2: √çTEMS FIJOS DE LA TIENDA
        const STORE_ITEMS = [
             { id: 'SKIN1', name: 'Parche de Pirate Cove', cost: 10, url: 'https://placehold.co/100x100/5b21b6/fff?text=PARCHE' },
             { id: 'SKIN2', name: 'Gafas de Visi√≥n Nocturna', cost: 25, url: 'https://placehold.co/100x100/111/4d7c0f?text=GOGGLES' },
             { id: 'SKIN3', name: 'Ojo de Endoskeleton', cost: 50, url: 'https://placehold.co/100x100/111/f59e0b?text=EYE' },
             { id: 'SKIN4', name: 'Sombrero de Guardia', cost: 100, url: 'https://placehold.co/100x100/1e293b/fff?text=HAT' }
        ];
        
        // UX-2: ESTADOS FICTICIOS DE ANIMATR√ìNICOS PARA EL MAPA
        const ANIMATRONIC_STATUS = [
            { name: 'Freddy Fazbear', status: 'Inactivo', location: 'Show Stage' },
            { name: 'Bonnie the Bunny', status: 'Movimiento', location: 'Backstage' },
            { name: 'Chica the Chicken', status: 'Reporte de ruido', location: 'Kitchen (Audio ON)' },
            { name: 'Foxy the Pirate', status: 'Desconocido', location: 'Pirate Cove' }
        ];

        // === ID √öNICO Y ADMINISTRADOR ===
        const ADMIN_USER_ID = 'user_1761249985103_s9rt1tp1j'; 
        let USER_ID;
        let IS_ADMIN;
        let maintenanceMode = false;
        
        function getUserId() {
             let id = localStorage.getItem('userId');
             if (!id) {
                 id = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4);
                 localStorage.setItem('userId', id);
             }
             return id;
         }

        // ===================================
        // === FUNCIONES DE AUTH Y RELOJ (SIN CAMBIOS) ===
        // ===================================

        function showLogin() {
             document.getElementById('login-section').classList.remove('hidden');
             document.getElementById('create-section').classList.add('hidden');
             document.getElementById('auth-title').textContent = 'INICIAR TURNO DE NOCHE';
             document.getElementById('login-pin').value = '';
        }

        async function showCreateProfile() {
            const { data: config } = await supabase.from('config').select('maintenance_mode').single();
            maintenanceMode = config ? config.maintenance_mode : false;

            if (maintenanceMode) {
                 document.getElementById('maintenance-warning').classList.remove('hidden');
                 document.getElementById('create-section').querySelector('.pizza-btn').disabled = true;
            } else {
                 document.getElementById('maintenance-warning').classList.add('hidden');
                 document.getElementById('create-section').querySelector('.pizza-btn').disabled = false;
            }

            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('create-section').classList.remove('hidden');
            document.getElementById('auth-title').textContent = 'CREAR N√öMERO DE GUARDIA';
            document.getElementById('new-name').value = '';
            document.getElementById('new-pin').value = '';
        }

        async function loginWithPin() {
             const pin = document.getElementById('login-pin').value;
             if (pin.length !== 4) {
                 alert('El N√∫mero de Guardia debe ser de 4 d√≠gitos.');
                 return;
             }

             const userId = getUserId();
             
             const { data: profile } = await supabase.from('profiles').select('pin').eq('user_id', userId).single();

             if (profile && profile.pin === pin) {
                 startApp(); 
                 return;
             }
             
             const { data: profileMatch } = await supabase.from('profiles').select('*').eq('pin', pin).single();

             if (profileMatch) {
                 localStorage.setItem('userId', profileMatch.user_id);
                 startApp();
             } else {
                 alert('N√∫mero de Guardia o ID incorrecto. Intenta de nuevo o crea un perfil.');
             }
        }
        
        async function createNewProfile() {
             const name = document.getElementById('new-name').value.trim();
             const pin = document.getElementById('new-pin').value;

             if (!name || pin.length !== 4) {
                 alert('Nombre de usuario y PIN de 4 d√≠gitos son obligatorios.');
                 return;
             }

             if (maintenanceMode) {
                 alert('El ingreso de nuevos guardias est√° temporalmente cerrado por mantenimiento.');
                 return;
             }
             
             const createBtn = document.getElementById('create-section').querySelector('.pizza-btn');
             createBtn.textContent = 'CARGANDO...';
             createBtn.disabled = true;

             const { data: existing } = await supabase.from('profiles').select('*').or(`name.eq.${name},pin.eq.${pin}`);
             if (existing && existing.length > 0) {
                 if (existing.some(p => p.name === name)) {
                     alert('El nombre de usuario ya est√° en uso. Elige otro.');
                 }
                 if (existing.some(p => p.pin === pin)) {
                     alert('Ese N√∫mero de Guardia (PIN) ya est√° en uso. Elige otro.');
                 }
                 createBtn.textContent = 'CREAR PERFIL';
                 createBtn.disabled = false;
                 return;
             }

             const newUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
             
             // ECON-1: Se a√±ade faz_tokens: 0
             const { error } = await supabase.from('profiles').insert({
                 user_id: newUserId,
                 name: name,
                 pin: pin,
                 bio: 'Nuevo guardia de noche.',
                 faz_tokens: 0 
             });

             if (error) {
                 console.error(error);
                 alert('Error al crear el perfil. Intenta de nuevo.');
                 createBtn.textContent = 'CREAR PERFIL';
                 createBtn.disabled = false;
                 return;
             }

             localStorage.setItem('userId', newUserId);
             startApp();
        }

        function handleAuth() {
             USER_ID = getUserId();
             IS_ADMIN = (USER_ID === ADMIN_USER_ID); 
             document.getElementById('display-user-id').textContent = USER_ID;
             
             if (USER_ID.startsWith('temp_')) {
                 document.getElementById('app-monitor').classList.add('hidden');
                 document.getElementById('auth-screen').classList.remove('hidden');
                 showCreateProfile();
             } else {
                 document.getElementById('app-monitor').classList.add('hidden');
                 document.getElementById('auth-screen').classList.remove('hidden');
                 showLogin();
             }
        }
        
        function logout() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar tu turno de noche? Deber√°s ingresar tu PIN nuevamente.')) {
                 localStorage.removeItem('userId'); 
                 window.location.reload();
            }
        }

        let clockInterval;
        const totalGameMinutes = 360; // 6 horas
        
        function formatGameTimeDisplay(gameMinutes) {
             let hours = Math.floor(gameMinutes / 60);
             let minutes = gameMinutes % 60;

             if (hours >= 6) return '06:00 AM';

             const hourDisplay = hours === 0 ? '12' : (hours < 10 ? '0' + hours : hours);
             const minuteDisplay = minutes < 10 ? '0' + minutes : minutes;

             if (hours === 0) return `12:${minuteDisplay} AM`; 
             return `${hourDisplay}:${minuteDisplay} AM`;
        }
        
        function formatTime(ms) {
             const seconds = Math.floor(ms / 1000);
             const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
             const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
             const s = String(seconds % 60).padStart(2, '0');
             return `${h}:${m}:${s}`;
        }
        
        function updateClock() {
             if (loginTime) {
                 const elapsed = Date.now() - loginTime;
                 document.getElementById('session-time').textContent = formatTime(elapsed);

                 const secondsElapsed = Math.floor(elapsed / 1000);
                 const gameMinutes = Math.min(secondsElapsed, totalGameMinutes);

                 document.getElementById('clock').textContent = formatGameTimeDisplay(gameMinutes);
             }
        }

        function startApp() {
             USER_ID = getUserId();
             IS_ADMIN = (USER_ID === ADMIN_USER_ID); 
             document.getElementById('display-user-id').textContent = USER_ID;
             
             loginTime = Date.now(); 

             document.getElementById('auth-screen').classList.add('hidden');
             document.getElementById('app-monitor').classList.remove('hidden');

             clearInterval(clockInterval);
             clockInterval = setInterval(updateClock, 1000);
             updateClock();

             initApp();
        }

        setTimeout(() => {
            document.getElementById('progress').style.width = '100%';
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash').remove();
                    handleAuth(); 
                }, 1000);
            }, 800);
        }, 1500);
        
        // === CAMBIOS V13.1: INICIO DE AUTOREFRESH ===
        let autoRefreshInterval;
        
        function startAutoRefresh() {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                if (currentTab === 'feed') {
                    loadFeed();
                } else if (currentTab === 'cameras') {
                    loadCameras();
                } else if (currentTab === 'map') {
                    loadMap(false); // Refresca solo el reporte, no el mapa base
                }
            }, REFRESH_INTERVAL);
        }

        async function initApp() {
            if (IS_ADMIN) {
                 document.getElementById('admin-options').classList.remove('hidden');
                 await loadMaintenanceMode();
            } else {
                 document.getElementById('admin-options').classList.add('hidden');
            }

            loadProfile();
            loadFeed();
            loadCameras();
            loadChat();
            loadShop(); 
            loadMap(true); // Carga inicial del mapa
            setupRealtime();
            startAutoRefresh(); // UX-1: Inicia el refresco autom√°tico
            switchTab('feed', false); 
        }

        async function loadMaintenanceMode() {
            const { data: config } = await supabase.from('config').select('maintenance_mode').single();
            maintenanceMode = config ? config.maintenance_mode : false;
            document.getElementById('maintenance-mode').checked = maintenanceMode;
        }

        async function toggleMaintenanceMode() {
            const isChecked = document.getElementById('maintenance-mode').checked;
            maintenanceMode = isChecked;

            const { error } = await supabase.from('config').upsert(
                 { id: 1, maintenance_mode: isChecked }, 
                 { onConflict: 'id' }
            );

            if (error) {
                 alert('Error al cambiar el modo mantenimiento: ' + error.message);
                 document.getElementById('maintenance-mode').checked = !isChecked; 
                 maintenanceMode = !isChecked;
            } else {
                 alert(`Modo Mantenimiento ${isChecked ? 'ACTIVADO' : 'DESACTIVADO'}.`);
            }
        }


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function switchTab(tab, autoClose = true) {
            currentTab = tab;
            document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
            
            let headerText = 'Fazbear Social Hub';
            if (IS_ADMIN) {
                 headerText += ' (ADMIN)';
            }
            document.getElementById('header-title').textContent = headerText;

            document.getElementById(tab).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const tabButton = document.getElementById('tab-' + tab);
            if (tabButton) {
                tabButton.classList.add('active');
            }

            if (tab === 'feed' || tab === 'cameras') {
                 document.getElementById('fab').style.display = 'flex';
            } else {
                 document.getElementById('fab').style.display = 'none';
            }

            if (autoClose && !document.getElementById('sidebar').classList.contains('-translate-x-full')) {
                 toggleSidebar();
            }
            
            if (tab === 'feed') {
                 localStorage.removeItem('hasNewComment'); 
                 localStorage.removeItem('hasNewLike'); 
                 checkNotifications(); 
            }
            if (tab === 'shop') { 
                 loadShop();
            }
            if (tab === 'map') { 
                 loadMap(false); 
            }
            if (tab === 'chat') { 
                 const chatMessages = document.getElementById('chat-messages');
                 setTimeout(() => { 
                     chatMessages.scrollTop = chatMessages.scrollHeight; 
                 }, 50);
            }
        }

        function openPostModal() {
            document.getElementById('post-modal').classList.remove('hidden');
            document.getElementById('post-content').value = '';
            document.getElementById('post-file').value = '';
            document.getElementById('submit-post-btn').textContent = 'PUBLICAR';
            document.getElementById('submit-post-btn').disabled = false;

            if (currentTab === 'cameras') {
                 document.getElementById('modal-title').textContent = 'NUEVA GRABACI√ìN DE C√ÅMARA';
                 document.getElementById('file-label').textContent = 'Video (M√°x 5MB)';
                 document.getElementById('post-file').accept = 'video/mp4,video/quicktime';
                 document.getElementById('video-warning').classList.remove('hidden');
                 document.getElementById('post-content').placeholder = 'Descripci√≥n del clip...';
            } else {
                 document.getElementById('modal-title').textContent = 'NUEVA TEOR√çA';
                 document.getElementById('file-label').textContent = 'Imagen (M√°x 5MB)';
                 document.getElementById('post-file').accept = 'image/*';
                 document.getElementById('video-warning').classList.add('hidden');
                 document.getElementById('post-content').placeholder = 'Tu teor√≠a...';
            }
        }

        function closePostModal() {
            document.getElementById('post-modal').classList.add('hidden');
            document.getElementById('post-content').value = '';
            document.getElementById('post-file').value = '';
        }

        // === FUNCIONES DE AVATAR CON GEAR ===
        function renderAvatarHTML(profile, size = 'w-10 h-10') {
            const profileAvatar = profile.avatar || DEFAULT_AVATAR;
            const gearStyle = profile.gear_url ? `
                 <img src="${profile.gear_url}" class="avatar-gear">
            ` : '';
            
            return `
                 <div class="avatar-container ${size} flex-shrink-0">
                     <img src="${profileAvatar}" class="avatar-base">
                     ${gearStyle}
                 </div>
            `;
        }

        async function getProfileInfo(userId) {
            if (profilesCache[userId]) return profilesCache[userId];

            const { data: profileData } = await supabase.from('profiles').select('*, faz_tokens, gear_url, gear_id').eq('user_id', userId).single();
            const { count: followersCount } = await supabase.from('followers').select('*', { count: 'exact' }).eq('following_id', userId);
            
            const defaultProfile = { 
                 name: userId === USER_ID ? 'T√ö (Sin Nombre)' : 'An√≥nimo', 
                 bio: userId === USER_ID ? 'A√∫n no has escrito tu biograf√≠a.' : 'Este usuario a√∫n no ha escrito su biograf√≠a.', 
                 avatar: DEFAULT_AVATAR 
            };
            
            const profile = profileData ? {
                 name: profileData.name,
                 bio: profileData.bio || defaultProfile.bio,
                 avatar: profileData.avatar_url || DEFAULT_AVATAR,
                 followers: followersCount || 0,
                 pin: profileData.pin,
                 faz_tokens: profileData.faz_tokens || 0,
                 gear_url: profileData.gear_url,
                 gear_id: profileData.gear_id
            } : { ...defaultProfile, avatar: DEFAULT_AVATAR, followers: followersCount || 0, faz_tokens: 0, gear_url: null, gear_id: null };

            profilesCache[userId] = profile;
            return profile;
        }

        async function loadProfile(fullLoad = true) {
             const profile = await getProfileInfo(USER_ID);

             // Update Header Tokens
             document.getElementById('faz-tokens-display').textContent = profile.faz_tokens;

             // Update Profile Tab
             if (fullLoad) {
                 document.getElementById('profile-avatar-display').innerHTML = renderAvatarHTML(profile, 'w-10 h-10');
                 document.getElementById('profile-name').value = profile.name;
                 document.getElementById('profile-bio').value = profile.bio;
                 document.getElementById('display-user-pin').textContent = profile.pin;
                 
                 // Stats (Need to fetch post/like counts separately as they aren't in the profile table)
                 const { count: postsCount } = await supabase.from('posts').select('*', { count: 'exact' }).eq('user_id', USER_ID);
                 const { count: totalLikes } = await supabase.from('likes').select('*', { count: 'exact' }).eq('target_user_id', USER_ID); // Assuming there's a target_user_id on likes table or a view

                 document.getElementById('profile-tokens').textContent = profile.faz_tokens;
                 document.getElementById('profile-total-likes').textContent = totalLikes || 0;
                 document.getElementById('profile-total-posts').textContent = postsCount || 0;
             }
             
             // Update FAB (Avatar)
             document.getElementById('fab-avatar').src = profile.avatar || DEFAULT_AVATAR; 
        }

        async function saveProfile() {
            const name = document.getElementById('profile-name').value.trim();
            const bio = document.getElementById('profile-bio').value.trim();
            const avatarFile = document.getElementById('profile-avatar-file').files[0];
            const saveBtn = document.getElementById('save-profile-btn');
            
            saveBtn.textContent = 'GUARDANDO...';
            saveBtn.disabled = true;

            if (!name) {
                 alert('El nombre de usuario es obligatorio.');
                 saveBtn.textContent = 'GUARDAR PERFIL';
                 saveBtn.disabled = false;
                 return;
            }

            let avatarUrl = (await getProfileInfo(USER_ID)).avatar_url; // Default to current URL

            if (avatarFile) {
                 avatarUrl = await uploadFile(avatarFile, 'avatars', 'public_avatars');
                 if (!avatarUrl) {
                      saveBtn.textContent = 'GUARDAR PERFIL';
                      saveBtn.disabled = false;
                      return;
                 }
            }
            
            const { error } = await supabase.from('profiles')
                 .update({ name: name, bio: bio, avatar_url: avatarUrl })
                 .eq('user_id', USER_ID);

            if (error) {
                 alert('Error al guardar perfil: ' + error.message);
            } else {
                 alert('Perfil guardado exitosamente.');
                 delete profilesCache[USER_ID]; // Clear cache to force reload
                 loadProfile();
            }
            
            saveBtn.textContent = 'GUARDAR PERFIL';
            saveBtn.disabled = false;
        }


        // === SUPABASE STORAGE (SIN CAMBIOS) ===
        async function uploadFile(file, bucket, folder = 'public') {
            if (!file) return null;

            if (file.size > MAX_FILE_SIZE) {
                 alert(`El archivo es muy grande. El l√≠mite es de ${MAX_FILE_SIZE / (1024 * 1024)}MB.`);
                 return null;
            }

            const filePath = `${folder}/${USER_ID}_${Date.now()}_${file.name}`;
            const { error } = await supabase.storage.from(bucket).upload(filePath, file);

            if (error) {
                 alert('Error subiendo el archivo: ' + error.message);
                 return null;
            }

            const { data } = supabase.storage.from(bucket).getPublicUrl(filePath);
            return data.publicUrl;
        }

        // === FEED Y INTERACCIONES ===
        window.handleSearch = () => {
             const query = document.getElementById('search-input').value.trim();
             loadFeed(false, query);
        }

        async function loadFeed(isManualRefresh = false, searchQuery = '') {
            if (isManualRefresh) profilesCache = {};

            let query = supabase.from('posts').select('*').order('created_at', { ascending: false });

            if (searchQuery) {
                 // Busca por contenido del post o nombre de usuario
                 query = query.or(`content.ilike.%${searchQuery}%,name.ilike.%${searchQuery}%`); 
            }

            const { data: posts, error: postsError } = await query;
            if (postsError) {
                 console.error('Error loading posts:', postsError);
                 return;
            }

            const { data: userLikes } = await supabase.from('likes').select('post_id').eq('user_id', USER_ID);
            const liked = userLikes?.map(l => l.post_id) || [];

            const userIds = [...new Set(posts.map(p => p.user_id))];
            await Promise.all(userIds.map(id => getProfileInfo(id)));

            const container = document.getElementById('feed');
            container.innerHTML = `
                <div class="mb-4">
                     <input type="text" id="search-input" placeholder="Buscar teor√≠as, usuarios o temas..." class="comment-input" onkeyup="handleSearch()" value="${searchQuery}">
                </div>
                <div class="flex justify-center mb-4">
                     <button onclick="loadFeed(true)" class="pizza-btn">üîÑ ACTUALIZAR FEED</button>
                </div>
            `;

            if (posts.length === 0) {
                 container.innerHTML += `<p class="text-center text-purple-500">¬°S√© el primero!</p>`;
                 return;
            }

            posts.forEach(post => {
                 const profile = profilesCache[post.user_id] || { name: 'An√≥nimo', avatar: DEFAULT_AVATAR };
                 const isLiked = liked.includes(post.id);
                 const deleteBtn = (post.user_id === USER_ID || IS_ADMIN) 
                     ? `<span class="delete-btn" onclick="deletePost(${post.id}, 'posts')">BORRAR POST</span>`
                     : '';
                     
                 const mediaHTML = post.media_url 
                     ? `<img src="${post.media_url}" class="w-full mt-2 rounded-lg object-contain max-h-80" alt="Contenido de la Teor√≠a">`
                     : '';
                     
                 container.innerHTML += `
                     <div class="post" id="post-${post.id}">
                         <div class="flex items-start justify-between">
                             <div class="flex items-center">
                                 ${renderAvatarHTML(profile, 'w-10 h-10 mr-2')}
                                 <div>
                                     <span class="text-sm font-bold text-purple-400 username-link" onclick="loadUserProfile('${post.user_id}')">${profile.name}</span>
                                     <p class="text-xs text-gray-500">${new Date(post.created_at).toLocaleString()}</p>
                                 </div>
                             </div>
                             ${deleteBtn}
                         </div>
                         <p class="mt-2 text-white">${post.content}</p>
                         ${mediaHTML}
                         <div class="flex items-center mt-3 justify-between border-t border-gray-700 pt-2">
                             <button class="pizza-btn ${isLiked ? 'active-like' : ''}" onclick="handleLike(${post.id}, ${isLiked})">
                                 üçï Slice <span id="likes-${post.id}">${post.likes_count || 0}</span>
                             </button>
                             <button class="pizza-btn bg-gray-600 hover:bg-gray-500" onclick="toggleComments(${post.id})">
                                 Comentarios <span id="comments-count-${post.id}">${post.comments_count || 0}</span>
                             </button>
                         </div>
                         <div id="comments-section-${post.id}" class="comments-section mt-3 hidden">
                             <div id="comments-list-${post.id}"></div>
                             <div class="flex mt-2">
                                 <input type="text" id="comment-input-${post.id}" placeholder="Escribe un comentario..." class="comment-input flex-grow">
                                 <button class="send-btn" onclick="sendComment(${post.id})">Enviar</button>
                             </div>
                         </div>
                     </div>
                 `;
            });
            document.getElementById('search-input').value = searchQuery; // Preserve search input
        }

        // ===================================
        // === FUNCIONES DE INTERACCI√ìN (FEED) ===
        // ===================================

        async function handleLike(postId, isLiked) {
             const postElement = document.getElementById(`post-${postId}`);
             const likeBtn = postElement.querySelector('.pizza-btn');
             const likesCountEl = document.getElementById(`likes-${postId}`);
             
             likeBtn.disabled = true;

             if (isLiked) {
                 // UNLIKE: Borrar registro y decrementar contador
                 const { error: deleteError } = await supabase.from('likes').delete().match({ user_id: USER_ID, post_id: postId });
                 if (!deleteError) {
                      likeBtn.classList.remove('active-like');
                      likesCountEl.textContent = parseInt(likesCountEl.textContent) - 1;
                      // En un entorno real, la actualizaci√≥n del posts.likes_count la har√≠a un trigger en la base de datos.
                 } else {
                     console.error('Error al quitar like:', deleteError);
                 }
             } else {
                 // LIKE: Insertar registro e incrementar contador
                 const { error: insertError } = await supabase.from('likes').insert({ user_id: USER_ID, post_id: postId });
                 if (!insertError) {
                      likeBtn.classList.add('active-like');
                      likesCountEl.textContent = parseInt(likesCountEl.textContent) + 1;
                      // En un entorno real, la actualizaci√≥n del posts.likes_count la har√≠a un trigger en la base de datos.
                 } else {
                      console.error('Error al dar like:', insertError);
                 }
             }
             
             likeBtn.disabled = false;
        }

        async function toggleComments(postId) {
             const commentsSection = document.getElementById(`comments-section-${postId}`);
             commentsSection.classList.toggle('hidden');
             
             if (!commentsSection.classList.contains('hidden')) {
                 loadComments(postId);
             }
        }

        async function loadComments(postId) {
             const commentsList = document.getElementById(`comments-list-${postId}`);
             commentsList.innerHTML = '<p class="text-xs text-gray-500 text-center">Cargando comentarios...</p>';

             const { data: comments, error } = await supabase.from('comments')
                 .select('*')
                 .eq('post_id', postId)
                 .order('created_at', { ascending: true });

             if (error) {
                 console.error('Error loading comments:', error);
                 commentsList.innerHTML = '<p class="text-xs text-red-500 text-center">Error al cargar comentarios.</p>';
                 return;
             }
             
             if (comments.length === 0) {
                 commentsList.innerHTML = '<p class="text-xs text-gray-500 text-center">S√© el primero en comentar.</p>';
                 return;
             }

             const userIds = [...new Set(comments.map(c => c.user_id))];
             await Promise.all(userIds.map(id => getProfileInfo(id)));

             commentsList.innerHTML = comments.map(comment => {
                 const profile = profilesCache[comment.user_id] || { name: 'An√≥nimo', avatar: DEFAULT_AVATAR };
                 const deleteBtn = (comment.user_id === USER_ID || IS_ADMIN) 
                     ? `<span class="delete-btn" onclick="deleteComment(${comment.id}, ${postId})">Borrar</span>`
                     : '';

                 return `
                     <div class="bg-gray-700 p-2 rounded-lg mt-1 text-sm flex justify-between items-start">
                         <div class="flex items-center flex-grow">
                             ${renderAvatarHTML(profile, 'w-6 h-6 mr-2')}
                             <p><span class="font-bold text-purple-300 username-link" onclick="loadUserProfile('${comment.user_id}')">${profile.name}</span>: ${comment.content}</p>
                         </div>
                         ${deleteBtn}
                     </div>
                 `;
             }).join('');
        }

        async function sendComment(postId) {
             const input = document.getElementById(`comment-input-${postId}`);
             const content = input.value.trim();

             if (!content) return;
             
             input.disabled = true;

             const { error } = await supabase.from('comments').insert({
                 post_id: postId,
                 user_id: USER_ID,
                 content: content
             });

             if (error) {
                 console.error('Error al enviar comentario:', error);
                 alert('Error al enviar el comentario.');
             } else {
                 input.value = '';
                 loadComments(postId);
                 // Update comments count for the post (ideally via DB trigger)
                 const commentsCountEl = document.getElementById(`comments-count-${postId}`);
                 if (commentsCountEl) {
                      commentsCountEl.textContent = parseInt(commentsCountEl.textContent) + 1;
                 }
             }
             
             input.disabled = false;
        }

        async function deleteComment(commentId, postId) {
             if (confirm('¬øEst√°s seguro de que quieres BORRAR este comentario?')) {
                 // Check if the comment belongs to the user or if the user is Admin (Supabase RLS handles this, but client-side check is safer UX)
                 const { data: comment, error: fetchError } = await supabase.from('comments').select('user_id').eq('id', commentId).single();
                 
                 if (fetchError || !comment) {
                     alert('Error al verificar el comentario.');
                     return;
                 }
                 
                 if (comment.user_id !== USER_ID && !IS_ADMIN) {
                      alert('No tienes permiso para borrar comentarios de otros guardias.');
                      return;
                 }

                 const { error: deleteError } = await supabase.from('comments').delete().eq('id', commentId);
                 
                 if (deleteError) {
                      console.error('Error al borrar comentario:', deleteError);
                      alert('Error al borrar el comentario.');
                 } else {
                      // Update comments count
                      const commentsCountEl = document.getElementById(`comments-count-${postId}`);
                      if (commentsCountEl) {
                           commentsCountEl.textContent = Math.max(0, parseInt(commentsCountEl.textContent) - 1);
                      }
                      loadComments(postId);
                 }
             }
        }
        
        // ===================================
        // === FUNCIONES DE PERFIL Y TIENDA (SHOP) ===
        // ===================================

        function loadShop() {
             loadProfile(false); // Refresca los tokens
             const container = document.getElementById('shop-items');
             container.innerHTML = '<p class="text-center text-yellow-500">Cargando tienda...</p>';
             
             // Check which items the user owns to disable the purchase button
             supabase.from('profiles').select('gear_id, gear_url').eq('user_id', USER_ID).single().then(({ data: profile }) => {
                 
                 container.innerHTML = STORE_ITEMS.map(item => {
                     const isOwned = profile.gear_id === item.id;
                     const isEquipped = profile.gear_url === item.url;
                     const buttonText = isEquipped ? 'EQUIPADO ‚úÖ' : (isOwned ? 'EQUIPAR' : `COMPRAR (${item.cost} üí∞)`);
                     
                     return `
                         <div class="bg-gray-800 p-4 rounded border-2 border-yellow-500 flex flex-col items-center text-center">
                             <img src="${item.url}" alt="${item.name}" class="w-20 h-20 mb-2 object-contain">
                             <h3 class="text-white font-bold">${item.name}</h3>
                             <p class="text-sm text-gray-400">ID: ${item.id}</p>
                             <button class="pizza-btn w-full mt-3 bg-yellow-600 hover:bg-yellow-700" 
                                 onclick="handlePurchase('${item.id}', ${item.cost}, '${item.url}')" 
                                 ${isEquipped ? 'disabled' : ''}>
                                 ${buttonText}
                             </button>
                         </div>
                     `;
                 }).join('');
             });
        }

        async function handlePurchase(itemId, cost, itemUrl) {
             const profile = profilesCache[USER_ID];
             
             // 1. Check if item is already owned/equipped (for re-equipping)
             if (profile.gear_id === itemId) {
                 // Equip already owned item
                 const { error } = await supabase.from('profiles')
                     .update({ gear_url: itemUrl })
                     .eq('user_id', USER_ID);
                     
                 if (!error) {
                     alert(`¬°Has equipado ${STORE_ITEMS.find(i => i.id === itemId).name}!`);
                     profile.gear_url = itemUrl;
                     profilesCache[USER_ID] = profile; // Update cache
                     loadShop();
                     loadProfile(false); // Update profile avatar
                 } else {
                     alert('Error al equipar el √≠tem: ' + error.message);
                 }
                 return;
             }
             
             // 2. Check if user has enough tokens for purchase
             if (profile.faz_tokens < cost) {
                 alert('¬°Tokens insuficientes! Necesitas ' + cost + ' üí∞.');
                 return;
             }
             
             if (confirm(`¬øComprar ${STORE_ITEMS.find(i => i.id === itemId).name} por ${cost} tokens? Esto lo equipar√° inmediatamente.`)) {
                 
                 // 3. Perform the purchase (debit tokens and update gear/equip)
                 const newTokens = profile.faz_tokens - cost;

                 const { error } = await supabase.from('profiles')
                     .update({ 
                         faz_tokens: newTokens, 
                         gear_id: itemId, 
                         gear_url: itemUrl 
                     })
                     .eq('user_id', USER_ID);

                 if (!error) {
                     alert('¬°Compra exitosa! √çtem equipado.');
                     profile.faz_tokens = newTokens;
                     profile.gear_id = itemId;
                     profile.gear_url = itemUrl;
                     profilesCache[USER_ID] = profile; // Update cache
                     loadShop();
                     loadProfile(false); // Update profile avatar and token display
                 } else {
                     alert('Error en la transacci√≥n: ' + error.message);
                 }
             }
        }
        
        async function loadUserPosts(userId) {
             const container = document.getElementById('user-posts-list');
             container.innerHTML = '<p class="text-center text-gray-500">Cargando publicaciones...</p>';
             
             const { data: posts, error } = await supabase.from('posts')
                 .select('*')
                 .eq('user_id', userId)
                 .order('created_at', { ascending: false });

             if (error) {
                 console.error(error);
                 container.innerHTML = '<p class="text-center text-red-500">Error al cargar publicaciones.</p>';
                 return;
             }
             
             if (posts.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500">@${profilesCache[userId].name} no tiene publicaciones.</p>`;
                 return;
             }
             
             const { data: userLikes } = await supabase.from('likes').select('post_id').eq('user_id', USER_ID);
             const liked = userLikes?.map(l => l.post_id) || [];
             const profile = profilesCache[userId]; // Should be in cache from loadUserProfile

             container.innerHTML = posts.map(post => {
                 const isLiked = liked.includes(post.id);
                 const deleteBtn = (post.user_id === USER_ID || IS_ADMIN) 
                     ? `<span class="delete-btn" onclick="deletePost(${post.id}, 'posts')">BORRAR POST</span>`
                     : '';
                     
                 const mediaHTML = post.media_url 
                     ? `<img src="${post.media_url}" class="w-full mt-2 rounded-lg object-contain max-h-80" alt="Contenido de la Teor√≠a">`
                     : '';
                     
                 return `
                     <div class="post" id="post-${post.id}">
                         <div class="flex items-start justify-between">
                             <div class="flex items-center">
                                 ${renderAvatarHTML(profile, 'w-10 h-10 mr-2')}
                                 <div>
                                     <span class="text-sm font-bold text-purple-400">${profile.name}</span>
                                     <p class="text-xs text-gray-500">${new Date(post.created_at).toLocaleString()}</p>
                                 </div>
                             </div>
                             ${deleteBtn}
                         </div>
                         <p class="mt-2 text-white">${post.content}</p>
                         ${mediaHTML}
                         <div class="flex items-center mt-3 justify-between border-t border-gray-700 pt-2">
                             <button class="pizza-btn ${isLiked ? 'active-like' : ''}" onclick="handleLike(${post.id}, ${isLiked})">
                                 üçï Slice <span id="likes-${post.id}">${post.likes_count || 0}</span>
                             </button>
                             <button class="pizza-btn bg-gray-600 hover:bg-gray-500" onclick="toggleComments(${post.id})">
                                 Comentarios <span id="comments-count-${post.id}">${post.comments_count || 0}</span>
                             </button>
                         </div>
                         <div id="comments-section-${post.id}" class="comments-section mt-3 hidden">
                             <div id="comments-list-${post.id}"></div>
                             <div class="flex mt-2">
                                 <input type="text" id="comment-input-${post.id}" placeholder="Escribe un comentario..." class="comment-input flex-grow">
                                 <button class="send-btn" onclick="sendComment(${post.id})">Enviar</button>
                             </div>
                         </div>
                     </div>
                 `;
             }).join('');
        }
        
        async function loadUserProfile(userId) {
             targetUserId = userId;
             switchTab('user-profile-view', false);
             
             const profile = await getProfileInfo(userId);
             
             document.getElementById('view-avatar-container').innerHTML = renderAvatarHTML(profile, 'w-16 h-16');
             document.getElementById('view-name').textContent = `@${profile.name}`;
             document.getElementById('view-name-posts').textContent = `@${profile.name}`;
             document.getElementById('view-id').textContent = `ID: ${userId}`;
             document.getElementById('view-followers').textContent = profile.followers;
             document.getElementById('view-bio').textContent = profile.bio;
             
             if (userId === USER_ID) {
                 document.getElementById('follow-btn').classList.add('hidden');
                 document.getElementById('block-btn').classList.add('hidden');
             } else {
                 document.getElementById('follow-btn').classList.remove('hidden');
                 document.getElementById('block-btn').classList.remove('hidden');
                 
                 // Check follow status
                 const { data: follow } = await supabase.from('followers').select('*').match({ follower_id: USER_ID, following_id: userId }).single();
                 document.getElementById('follow-btn').textContent = follow ? 'DEJAR DE SEGUIR' : 'SEGUIR';
                 
                 // Check block status
                 const { data: block } = await supabase.from('blocks').select('*').match({ blocker_id: USER_ID, blocked_id: userId }).single();
                 document.getElementById('block-btn').textContent = block ? 'DESBLOQUEAR' : 'BLOQUEAR';
             }
             
             loadUserPosts(userId);
        }

        async function toggleFollow() {
             const btn = document.getElementById('follow-btn');
             btn.disabled = true;
             
             const isFollowing = btn.textContent === 'DEJAR DE SEGUIR';
             
             if (isFollowing) {
                 const { error } = await supabase.from('followers').delete().match({ follower_id: USER_ID, following_id: targetUserId });
                 if (!error) {
                     btn.textContent = 'SEGUIR';
                     const profile = profilesCache[targetUserId];
                     profile.followers = Math.max(0, profile.followers - 1);
                     document.getElementById('view-followers').textContent = profile.followers;
                 } else {
                     alert('Error al dejar de seguir: ' + error.message);
                 }
             } else {
                 const { error } = await supabase.from('followers').insert({ follower_id: USER_ID, following_id: targetUserId });
                 if (!error) {
                     btn.textContent = 'DEJAR DE SEGUIR';
                     const profile = profilesCache[targetUserId];
                     profile.followers = profile.followers + 1;
                     document.getElementById('view-followers').textContent = profile.followers;
                 } else {
                     alert('Error al seguir: ' + error.message);
                 }
             }
             
             btn.disabled = false;
        }

        async function toggleBlock() {
             const btn = document.getElementById('block-btn');
             btn.disabled = true;
             
             const isBlocking = btn.textContent === 'DESBLOQUEAR';
             
             if (isBlocking) {
                 const { error } = await supabase.from('blocks').delete().match({ blocker_id: USER_ID, blocked_id: targetUserId });
                 if (!error) {
                     btn.textContent = 'BLOQUEAR';
                 } else {
                     alert('Error al desbloquear: ' + error.message);
                 }
             } else {
                 const { error } = await supabase.from('blocks').insert({ blocker_id: USER_ID, blocked_id: targetUserId });
                 if (!error) {
                     alert(`¬°Bloqueaste a ${profilesCache[targetUserId].name}! Su contenido ya no aparecer√°.`);
                     btn.textContent = 'DESBLOQUEAR';
                 } else {
                     alert('Error al bloquear: ' + error.message);
                 }
             }
             
             btn.disabled = false;
        }

        // ===================================
        // === FUNCIONES DE MAPA, C√ÅMARAS Y CHAT ===
        // ===================================
        
        async function loadMap(isInitialLoad = false) {
             const container = document.getElementById('animatronic-status');
             
             if (isInitialLoad) {
                 container.innerHTML = `<p class="text-center text-green-500">Esperando reporte t√°ctico...</p>`;
             }
             
             // Esto es una simulaci√≥n de datos, no requiere DB, solo renderiza el estado ficticio.
             container.innerHTML = ANIMATRONIC_STATUS.map(animatronic => {
                 const color = animatronic.status === 'Movimiento' ? 'text-red-500' : (animatronic.status === 'Inactivo' ? 'text-green-500' : 'text-yellow-500');
                 return `
                     <div class="flex justify-between border-b border-gray-700 py-1">
                         <span class="font-bold">${animatronic.name}:</span>
                         <span class="${color}">${animatronic.status}</span>
                         <span class="text-gray-400">${animatronic.location}</span>
                     </div>
                 `;
             }).join('');
        }
        
        async function loadCameras(isManualRefresh = false) {
             if (isManualRefresh) profilesCache = {};
             const { data: cameras } = await supabase.from('cameras').select('*').order('created_at', { ascending: false });
             
             const userIds = [...new Set(cameras.map(c => c.user_id))];
             await Promise.all(userIds.map(id => getProfileInfo(id)));
             
             const container = document.getElementById('cameras-list');
             container.innerHTML = '';
             
             if (cameras.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500">No hay grabaciones activas.</p>`;
                 return;
             }
             
             cameras.forEach(camera => {
                 const profile = profilesCache[camera.user_id] || { name: 'An√≥nimo', avatar: DEFAULT_AVATAR };
                 const deleteBtn = (camera.user_id === USER_ID || IS_ADMIN) 
                     ? `<span class="delete-btn" onclick="deletePost(${camera.id}, 'cameras')">BORRAR GRABACI√ìN</span>`
                     : '';
                     
                 container.innerHTML += `
                     <div class="post bg-gray-900 border-green-500" id="camera-${camera.id}">
                         <div class="flex items-center justify-between">
                             <div class="flex items-center">
                                 ${renderAvatarHTML(profile, 'w-10 h-10 mr-2')}
                                 <div>
                                     <span class="text-sm font-bold text-green-400 username-link" onclick="loadUserProfile('${camera.user_id}')">${profile.name} (C√ÅMARA)</span>
                                     <p class="text-xs text-gray-500">${new Date(camera.created_at).toLocaleString()}</p>
                                 </div>
                             </div>
                             ${deleteBtn}
                         </div>
                         <video controls class="camera-video mt-2" src="${camera.media_url}" poster="https://placehold.co/800x400/000/fff?text=CARGANDO+VIDEO+DE+C√ÅMARA">
                             Tu navegador no soporta el elemento de video.
                         </video>
                         <p class="mt-2 text-white">${camera.content || 'Sin descripci√≥n'}</p>
                     </div>
                 `;
             });
        }
        
        async function loadChat() {
             const chatMessages = document.getElementById('chat-messages');
             const { data: messages, error } = await supabase.from('chat_messages')
                 .select('*')
                 .order('created_at', { ascending: true });

             if (error) {
                 console.error('Error loading chat:', error);
                 chatMessages.innerHTML = '<p class="text-center text-red-500">Error al cargar el chat.</p>';
                 return;
             }
             
             const userIds = [...new Set(messages.map(m => m.user_id))];
             await Promise.all(userIds.map(id => getProfileInfo(id)));

             const isAtBottom = chatMessages.scrollHeight - chatMessages.scrollTop === chatMessages.clientHeight;
             chatMessages.innerHTML = messages.map(message => {
                 const profile = profilesCache[message.user_id] || { name: 'An√≥nimo', avatar: DEFAULT_AVATAR };
                 const isMe = message.user_id === USER_ID;
                 const deleteBtn = (isMe || IS_ADMIN) 
                     ? `<span class="delete-btn" onclick="deleteChat(${message.id})">x</span>`
                     : '';
                 
                 const alignment = isMe ? 'justify-end' : 'justify-start';
                 const color = isMe ? 'bg-purple-700' : 'bg-gray-700';
                 
                 return `
                     <div class="flex ${alignment} mb-2">
                         <div class="${color} p-3 rounded-lg max-w-xs relative">
                             <div class="flex items-center mb-1">
                                 ${renderAvatarHTML(profile, 'w-6 h-6 mr-2')}
                                 <span class="font-bold text-sm text-yellow-300 username-link" onclick="loadUserProfile('${message.user_id}')">${profile.name}</span>
                             </div>
                             <p class="text-white text-base">${message.content}</p>
                             <span class="text-xs text-gray-300 block text-right">${new Date(message.created_at).toLocaleTimeString().substring(0, 5)}</span>
                             ${deleteBtn}
                         </div>
                     </div>
                 `;
             }).join('');

             if (isAtBottom) {
                 chatMessages.scrollTop = chatMessages.scrollHeight;
             }
        }
        
        async function sendChat() {
             const input = document.getElementById('chat-input');
             const content = input.value.trim();

             if (!content) return;
             
             input.disabled = true;

             const { error } = await supabase.from('chat_messages').insert({
                 user_id: USER_ID,
                 content: content
             });

             if (error) {
                 console.error('Error al enviar mensaje:', error);
                 alert('Error al enviar el mensaje.');
             } else {
                 input.value = '';
                 loadChat();
             }
             
             input.disabled = false;
        }

        // ===================================
        // === FUNCIONES DE UTILIDAD ===
        // ===================================

        async function submitPost() {
             const content = document.getElementById('post-content').value.trim();
             const fileInput = document.getElementById('post-file');
             const file = fileInput.files[0];
             
             if (!content && !file) {
                 alert('Debes escribir algo o subir una imagen/video.');
                 return;
             }
             
             const submitBtn = document.getElementById('submit-post-btn');
             submitBtn.textContent = 'PUBLICANDO...';
             submitBtn.disabled = true;

             let mediaUrl = null;
             let table = (currentTab === 'cameras') ? 'cameras' : 'posts';

             if (file) {
                 const bucket = (currentTab === 'cameras') ? 'videos' : 'images';
                 mediaUrl = await uploadFile(file, bucket);
                 if (!mediaUrl) {
                      submitBtn.textContent = 'PUBLICAR';
                      submitBtn.disabled = false;
                      return;
                 }
             }

             const postData = {
                 user_id: USER_ID,
                 content: content,
                 media_url: mediaUrl
             };

             const { error } = await supabase.from(table).insert(postData);

             if (error) {
                 console.error(error);
                 alert('Error al publicar: ' + error.message);
             } else {
                 closePostModal();
                 if (currentTab === 'feed') loadFeed(true);
                 if (currentTab === 'cameras') loadCameras(true);
             }
             
             submitBtn.textContent = 'PUBLICAR';
             submitBtn.disabled = false;
        }

        function setupRealtime() {
             // Realtime para Chat
             supabase.channel('chat_messages_changes')
                 .on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, () => {
                     if (currentTab === 'chat') {
                         loadChat();
                     } else if (currentTab === 'feed') {
                         localStorage.setItem('hasNewComment', 'true');
                         checkNotifications();
                     }
                 })
                 .subscribe();
                 
             // Realtime para Feed y Likes/Comments (para notificaciones)
             supabase.channel('posts_changes')
                 .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, (payload) => {
                     if (currentTab !== 'feed') {
                         if (payload.eventType === 'INSERT') {
                             localStorage.setItem('hasNewPost', 'true');
                             checkNotifications();
                         }
                         // Notificaci√≥n para likes
                         if (payload.eventType === 'UPDATE' && payload.new.likes_count > payload.old.likes_count) {
                              localStorage.setItem('hasNewLike', 'true');
                              checkNotifications();
                         }
                     } else {
                          // If on feed tab, just refresh quietly
                          loadFeed();
                     }
                 })
                 .subscribe();
        }

        function checkNotifications() {
             const hasNew = localStorage.getItem('hasNewPost') === 'true' || 
                            localStorage.getItem('hasNewComment') === 'true' || 
                            localStorage.getItem('hasNewLike') === 'true';

             const dot = document.getElementById('feed-notification-dot');
             if (dot) {
                 dot.style.display = hasNew ? 'block' : 'none';
             }
        }
        
        async function deletePost(postId, table) {
             if (confirm(`¬øEst√°s seguro de que quieres BORRAR este elemento de ${table}?`)) {
                 // Usamos .eq('user_id', USER_ID) para que s√≥lo el due√±o pueda borrarlo (a menos que seas admin y RLS lo permita)
                 const { error } = await supabase.from(table).delete().eq('id', postId);
                 
                 if (error && error.code === '42501' && !IS_ADMIN) { 
                     alert('No tienes permiso para borrar publicaciones de otros guardias.');
                 } else if (error) {
                     console.error(error);
                     alert('Error al borrar la publicaci√≥n.');
                 } else {
                     alert('Elemento borrado.');
                     if (table === 'posts') loadFeed(true);
                     if (table === 'cameras') loadCameras(true);
                 }
             }
        }

        async function deleteChat(chatId) {
             if (confirm('¬øBorrar este mensaje?')) {
                 // Permitir el borrado si eres el admin o el user_id coincide.
                 const { error } = await supabase.from('chat_messages').delete().eq('id', chatId); 

                 if (error && error.code === '42501' && !IS_ADMIN) {
                      alert('No tienes permiso para borrar mensajes de otros.');
                 } else if (error) {
                      console.error(error);
                      alert('Error al borrar el mensaje.');
                 } else {
                      loadChat();
                 }
             }
        }
        
    </script>
</body>
</html>
